<?php

namespace shop\modules\vendor\models;

use yii;
use common\components\Help;
use shop\modules\product\models\Product;
use shop\modules\product\models\ProductsToCategory;

/**
 * This is the model class for table "cw_vendor".
 *
 * @property integer $id
 * @property string $route
 * @property string $name
 * @property integer $synonym
 * @property integer $status
 * @property string $logo
 * @property integer $priority
 * @property string $description
 */
class Vendor extends \yii\db\ActiveRecord
{

  const STATUS_OFF = 0;
  const STATUS_ACTIVE = 1;
  const STATUS_WAINING = 2;

    /**
     * @inheritdoc
     */
    public static function tableName()
    {
        return 'cw_vendor';
    }

    /**
     * @inheritdoc
     */
    public function rules()
    {
        return [
            [['route', 'name'], 'required'],
            [['synonym', 'status', 'priority'], 'integer'],
            [['description'], 'string'],
            [['route'], 'string', 'max' => 30],
            [['name', 'logo'], 'string', 'max' => 255],
            [['route'], 'unique'],
        ];
    }

    /**
     * @inheritdoc
     */
    public function attributeLabels()
    {
        return [
            'id' => 'ID',
            'route' => 'Route',
            'name' => 'Name',
            'synonym' => 'Synonym',
            'status' => 'Status',
            'logo' => 'Logo',
            'priority' => 'Priority',
            'description' => 'Description',
        ];
    }

    public function beforeValidate()
    {
        if (empty($this->route)) {
            $i = 1;
            $rout = \Yii::$app->help->makeRoute($this->name);
            $this->route = $rout;
            while ($this->testRoute()) {
                $i++;
                $this->route = $rout . '_' . $i;
            }
        } else {
            $this->route = \Yii::$app->help->makeRoute($this->route);
        }
        return parent::beforeValidate(); // TODO: Change the autogenerated stub
    }

    public static function items($params)
    {
        $cache = \Yii::$app->cache;
        $dependency = new yii\caching\DbDependency;
        $dependencyName = 'catalog_product';
        $language = Yii::$app->language == Yii::$app->params['base_lang'] ? false : Yii::$app->language;
        $casheName = 'vendor_items_' . ($params ? '_'.Help::multiImplode('_', $params) : '') .
            ($language ? '_' . $language : '');
        $dependency->sql = 'select `last_update` from `cw_cache` where `name` = "' . $dependencyName . '"';

        $out = $cache->getOrSet($casheName, function () use ($params) {
            $vendors = self::find()
                ->from(self::tableName().' v')
                ->leftJoin(Product::tableName(). ' p', 'p.vendor_id = v.id')
                ->select(['v.id', 'v.name', 'v.route', 'count(p.id) as count'])
                ->where(['v.status' => self::STATUS_ACTIVE])
                ->groupBy(['v.id', 'v.name', 'v.route'])
                ->orderBy(['count' => SORT_DESC])
                ->asArray();
            if (!empty($params['limit'])) {
                $vendors->limit($params['limit']);
            }
            if (!empty($params['category'])) {
                $vendors->innerJoin(ProductsToCategory::tableName(). ' ptc', 'ptc.product_id = p.id')
                    ->andWhere(['ptc.category_id' => $params['category']]);
            }
            if (!empty($params['where'])) {
                $vendors->andWhere($params['where']);
            }
            return !empty($params['count']) ? $vendors->count() : $vendors->all();
        }, $cache->defaultDuration, $dependency);
        return $out;
    }

    private function testRoute()
    {
        $where = $this->id === null ?
            ['route' => $this->route] :
            ['and', ['route' => $this->route], ['<>', 'id', $this->id]];
        $cnt = self::find()
            ->where($where)
            ->count();
        return $cnt > 0;
    }
}
