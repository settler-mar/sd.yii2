<?php

namespace shop\modules\vendor\models;

use Yii;

/**
 * This is the model class for table "cw_vendor".
 *
 * @property integer $id
 * @property string $route
 * @property string $name
 * @property integer $synonym
 * @property integer $status
 * @property string $logo
 * @property integer $priority
 * @property string $description
 */
class Vendor extends \yii\db\ActiveRecord
{

  const STATUS_OFF = 0;
  const STATUS_ACTIVE = 1;
  const STATUS_WAINING = 2;

    /**
     * @inheritdoc
     */
    public static function tableName()
    {
        return 'cw_vendor';
    }

    /**
     * @inheritdoc
     */
    public function rules()
    {
        return [
            [['route', 'name'], 'required'],
            [['synonym', 'status', 'priority'], 'integer'],
            [['description'], 'string'],
            [['route'], 'string', 'max' => 30],
            [['name', 'logo'], 'string', 'max' => 255],
            [['route'], 'unique'],
        ];
    }

    /**
     * @inheritdoc
     */
    public function attributeLabels()
    {
        return [
            'id' => 'ID',
            'route' => 'Route',
            'name' => 'Name',
            'synonym' => 'Synonym',
            'status' => 'Status',
            'logo' => 'Logo',
            'priority' => 'Priority',
            'description' => 'Description',
        ];
    }

    public function beforeValidate()
    {
      if(empty($this->route)){
        $i=1;
        $rout = \Yii::$app->help->makeRoute($this->name);
        $this->route = $rout;

        while($this->testRoute()){
          $i++;
          $this->route = $rout.'_'.$i;
        }
      }else{
        $this->route = \Yii::$app->help->makeRoute($this->route);
      }
      return parent::beforeValidate(); // TODO: Change the autogenerated stub
    }

    private function testRoute(){
      $cnt = self::find()
          ->andWhere(['!=','id',$this->id])
          ->andWhere(['route'=>$this->route])
          ->count();

      return $cnt>0;
    }
}
