<?php

namespace frontend\modules\vendor\models;

use yii;
use common\components\Help;
use frontend\modules\product\models\Product;
use frontend\modules\product\models\ProductsToCategory;
use common\components\SdImage;

/**
 * This is the model class for table "cw_vendor".
 *
 * @property integer $id
 * @property string $route
 * @property string $name
 * @property integer $synonym
 * @property integer $status
 * @property string $logo
 * @property integer $priority
 * @property string $description
 */
class Vendor extends \yii\db\ActiveRecord
{

  const STATUS_OFF = 0;
  const STATUS_ACTIVE = 1;
  const STATUS_WAINING = 2;

  public $logoImage;

  public $imagePath = '/images/vendor/';

    /**
     * @inheritdoc
     */
    public static function tableName()
    {
        return 'cw_vendor';
    }

    /**
     * @inheritdoc
     */
    public function rules()
    {
        return [
            [['route', 'name'], 'required'],
            [['synonym', 'status', 'priority'], 'integer'],
            [['description'], 'string'],
            [['route'], 'string', 'max' => 30],
            [['name', 'logo'], 'string', 'max' => 255],
            [['route'], 'unique'],
            ['!logoImage', 'file', 'extensions' => 'jpeg,jpg,png', 'on' => ['insert', 'update']],
            [['logoImage'], 'image',
                'minHeight' => 120,
                'minWidth' => 120,
                'maxHeight' => 1200,
                'maxWidth' => 1200,
                'maxSize' => 10 * 1024 * 1024,
                'skipOnEmpty' => true
            ],

        ];
    }

    /**
     * @inheritdoc
     */
    public function attributeLabels()
    {
        return [
            'id' => 'ID',
            'route' => 'Route',
            'name' => 'Name',
            'synonym' => 'Synonym',
            'status' => 'Status',
            'logo' => 'Logo',
            'priority' => 'Priority',
            'description' => 'Description',
        ];
    }

    public function beforeValidate()
    {
        if (empty($this->route)) {
            $i = 1;
            $rout = \Yii::$app->help->makeRoute($this->name);
            $this->route = $rout;
            while ($this->testRoute()) {
                $i++;
                $this->route = $rout . '_' . $i;
            }
        } else {
            $this->route = \Yii::$app->help->makeRoute($this->route);
        }
        return parent::beforeValidate(); // TODO: Change the autogenerated stub
    }

    public function getSynonymVendor()
    {
        if (!$this->synonym) {
            return null;
        }
        return $this->hasOne(self::className(), ['id' => 'synonym']);
    }

    public function afterSave($insert, $changedAttributes)
    {
        parent::afterSave($insert, $changedAttributes);

        $this->saveImage();
    }

    public static function statusLabels()
    {
        return [
            self::STATUS_OFF => 'Неактивен',
            self::STATUS_ACTIVE => 'Активен',
            self::STATUS_WAINING => 'Ожидает подтверждения',
        ];
    }

    public static function statusClass($status) {
        switch ($status) {
            case (Vendor::STATUS_OFF):
                return 'status_1';
            case (Vendor::STATUS_ACTIVE):
                return 'status_2';
            default:
                return 'status_0';
        }
    }

    public static function items($params)
    {
        $cache = \Yii::$app->cache;
        $dependency = new yii\caching\DbDependency;
        $dependencyName = 'catalog_product';
        $language = Yii::$app->language == Yii::$app->params['base_lang'] ? false : Yii::$app->language;
        $casheName = 'vendor_items_' . ($params ? '_'.Help::multiImplode('_', $params) : '') .
            ($language ? '_' . $language : '');
        $dependency->sql = 'select `last_update` from `cw_cache` where `name` = "' . $dependencyName . '"';

        $out = $cache->getOrSet($casheName, function () use ($params) {
            $vendors = self::find()
                ->from(self::tableName().' v')
                ->innerJoin(Product::tableName(). ' p', 'p.vendor_id = v.id')
                ->select(['v.id as id', 'v.name as name', 'v.route as route', 'v.logo as logo', 'v.priority as priority'])
                ->where(['v.status' => self::STATUS_ACTIVE])
                ->groupBy(['id', 'name', 'route', 'logo', 'priority'])
                ->asArray();
            if (!empty($params['limit'])) {
                $vendors->limit($params['limit']);
            }
            if (!empty($params['category'])) {
                $vendors->innerJoin(ProductsToCategory::tableName(). ' ptc', 'ptc.product_id = p.id')
                    ->andWhere(['ptc.category_id' => $params['category']]);
            }
            if (!empty($params['where'])) {
                $vendors->andWhere($params['where']);
            }
            if (isset($params['database'])) {
                //связь с запросом к продуктам
                $dataBaseSelect = clone $params['database'];
                $dataBaseSelect->select(['prod.id']);
                $dataBaseSelect->orderBy([]);
                $dataBaseSelect->limit(null);
                if (isset($dataBaseSelect->having) && in_array('discount', $dataBaseSelect->having)) {
                    $dataBaseSelect->addSelect(['if (prod.old_price, (prod.old_price - prod.price)/prod.old_price, 0) as `discount`']);
                }
                $vendors->innerJoin(['product' => $dataBaseSelect], 'product.id = p.id');
            }
            if (isset($params['sort'])) {
                $vendors->orderBy($params['sort']);
            }
            $vendors = !empty($params['count']) ? $vendors->count() : $vendors->all();
            return $vendors;
        }, $cache->defaultDuration, $dependency);
        return $out;
    }

    private function testRoute()
    {
        $where = $this->id === null ?
            ['route' => $this->route] :
            ['and', ['route' => $this->route], ['<>', 'id', $this->id]];
        $cnt = self::find()
            ->where($where)
            ->count();
        return $cnt > 0;
    }

    /**
     * Сохранение изображения
     */
    public function saveImage()
    {
        $photo = \yii\web\UploadedFile::getInstance($this, 'logoImage');
        if ($photo && $image = SdImage::save($photo, $this->imagePath, 600, $this->logo)) {
            $this::getDb()
                ->createCommand()
                ->update($this->tableName(), ['logo' => $image], ['id' => $this->id])
                ->execute();
        }
    }
}
