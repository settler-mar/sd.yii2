{{ use('/yii/widgets/LinkPager') }}
{% set title = 'Пользователи' %}
{{ set(this, 'title', title) }}
{% if not this.params.breadcrumbs %}
  {{ set(this, 'params', this.params|merge({'breadcrumbs': []})) }}
{% endif %}
{% set breadcrumbs = this.params.breadcrumbs %}
{% set breadcrumbs = breadcrumbs|merge([title]) %}


<div class="content-wrapper">
  <section>
     <div class="col-md-12">
      {% if users|length > 0 %}
        <table class="table table-users">
          <thead>
          <tr>
            <th>Профиль</th>
            <th>Баланс</th>
            <th>Привелегии / акция</th>
            <th>Действия</th>
          </tr>
          </thead>
          <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div class="sum_information long_value">
                <div class="line">
                  <div class="name">ID</div>
                  <div class="value">{{user.uid}}</div>
                </div>
                <div class="line">
                  <div class="name">Email</div>
                  <div class="value">
                    <a href="/admin/users/update?id={{user.uid}}">{{ _hyphen_email(user.email) | raw}}</a>
                    {% if user.email_verified==1 %}
                      <i class="fa fa-check-circle-o" aria-hidden="true"></i>
                    {% endif %}
                  </div>
                </div>
                <div class="line">
                  <div class="name">Регистр.</div>
                  <div class="value">{{user.registration_source_href | raw}}</div>
                </div>
                <div class="line">
                  <div class="name name-none"></div>
                  <div class="value">{{user.added}}</div>
                </div>
                <div class="line">
                  <div class="name">Визит</div>
                  <div class="value">{{user.last_login}}</div>
                </div>
                <div class="line">
                  <div class="name">IP-авториз</div>
                  <div class="value">
                    {% if(user.last_ip_count>1) %}
                      <a href="/admin/users?ip={{ user.last_ip }}">{{ user.last_ip }} ({{ user.last_ip_count }})</a>
                    {% else %}
                      {{ user.last_ip }} ({{ user.last_ip_count }})
                    {% endif %}
                  </div>
                </div>
                <div class="line">
                  <div class="name">IP-рег.</div>
                  <div class="value">
                    {% if(user.reg_ip_count>1) %}
                      <a href="/admin/users?ip={{ user.reg_ip }}">{{ user.reg_ip }} ({{ user.reg_ip_count }})</a>
                    {% else %}
                      {{ user.reg_ip }} ({{ user.reg_ip_count }})
                    {% endif %}
                  </div>
                </div>
                <div class="line">
                  <div class="name">Привел</div>
                  <div class="value">
                    {% if  user.referrer_id>0 %}
                      <a href="/admin/users?ref_id={{ user.referrer_id }}">
                        {{ _hyphen_email(user.drive) | raw}} <wbr>({{ user.referrer_id }})
                      </a>
                    {% else %}
                      {{ _hyphen_email(user.drive) | raw}}
                    {% endif %}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <div class="sum_information">
                <b>Кэшбэк</b>
                <div class="line">
                  <div class="name">confirmed</div>
                  <div class="value">
                    {{ _nf(user.cnt_confirmed,0) | raw}}
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_confirmed) | raw }} р
                  </div>
                </div>
                <div class="line">
                  <div class="name">pending</div>
                  <div class="value">
                    {{ _nf(user.cnt_pending,0) | raw }}
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_pending) | raw }} р
                  </div>
                </div>
                <b>За рефералов</b>
                <div class="line">
                  <div class="name">confirmed</div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_from_ref_confirmed) | raw }} р
                  </div>
                </div>
                <div class="line">
                  <div class="name">pending</div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_from_ref_pending) | raw }} р
                  </div>
                </div>
                <div class="line">
                  <div class="name"><b>Бонусы</b></div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_bonus) | raw }} р
                  </div>
                </div>
                <div class="line">
                  <div class="name"><b>Благотворит.</b></div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_foundation) | raw }} р
                  </div>
                </div>
                <div class="line">
                  <div class="name"><b>Выплачено</b></div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.sum_withdraw) | raw }} р
                  </div>
                </div>
                <div class="line sum">
                  <div class="name"><b>Баланс</b></div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.currentBalance,2,false) | raw }}
                  </div>
                </div>
                <div class="line">
                  <div class="name"><b>В ожидании</b></div>
                  <div class="value">
                  </div>
                  <div class="value">
                    {{ _nf(user.pending) | raw }}
                  </div>
                </div>
              </div>
            </td>

            <td>
              <div class="sum_information">
                <div class="line">
                  <div class="name">Кэшбэк</div>
                  <div class="value">
                    {{user.loyalty_status_data.display_name}}
                    ({{user.loyalty_status_data.bonus}}%)
                    {% if user.loyalty_status_data.is_vip==1 %}
                      <br>VIP клиент
                    {% endif %}
                  </div>
                </div>
                {% if user.new_loyalty_status_end>0 %}
                  <div class="line">
                    <div class="name">до </div>
                    <div class="value">
                      {{ date(user.new_loyalty_status_end) }}
                    </div>
                  </div>
                  <div class="line">
                    <div class="name">после</div>
                    <div class="value">
                      {{user.old_loyalty_status_data.display_name}}
                      ({{user.old_loyalty_status_data.bonus}}%)
                    </div>
                  </div>
                {% endif %}
                <div class="line">
                  <div class="name">За рефералов</div>
                  <div class="value">
                    {{user.bonus_status_data.display_name}}
                    ({{user.bonus_status_data.bonus}}%)
                    {% if user.bonus_status_data.is_webmaster==1 %}
                      <br>для веб мастеров
                    {% endif %}
                  </div>
                </div>

                <div class="line">
                  <div class="name">Рефералов</div>
                  <div class="value">{{ _nf(user.ref_total,0) | raw }}</div>
                </div>
                <div class="line">
                  <div class="name">Активен</div>
                  <div class="value">{{ _if(user.is_active==1,'ДА','НЕТ') }}</div>
                </div>


                {% set action=user.action %}
                <div class="line sum">
                  <div class="name">В акции с</div>
                  <div class="value">{{ user.in_action }}</div>
                </div>
                <div class="line">
                  <div class="name">Привел в акцию</div>
                  <div class="value">{{ action.reg_by_action }}</div>
                </div>
                <div class="line">
                  <div class="name">Кэшбэк более 350</div>
                  <div class="value">{{ action.reg_by_action }}</div>
                </div>

              </div>
            </td>
            <td>
              <a href="/admin/users/update?id={{user.uid}}">Редактировать</a>
              <br>
              <a href="/admin/users/login?id={{user.uid}}">Login</a>

              <span class="ajax_remove" uid="{{user.uid}}" url="/admin/users/delete">
                      Удалить
                    </span>
              <!--<br>
                    <a class="delete" href="/admin/users/delete?id={{user.uid}}" onclick="if(!confirm('Уверены?')) return false;">Удалить</a>-->
            </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

      {% else %}
        <div class="col-md-12">
          <div class="not-found">На данный момент таких пользователей нет.</div>
        </div>
      {% endif %}
    </div>
</section>
</div>
