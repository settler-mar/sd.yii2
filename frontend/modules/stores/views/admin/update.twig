{{ use('/yii/widgets/ActiveForm') }}

{{ use('common/components/fileImageInput/FileInput') }}
{% set title = 'Update Stores: ' ~ model.name %}
{{ set(this, 'title', title) }}
{% if not this.params.breadcrumbs %}
{{ set(this, 'params', this.params|merge({'breadcrumbs': []})) }}
{% endif %}
{% set breadcrumbs = this.params.breadcrumbs %}
{% set breadcrumbs = breadcrumbs|merge([{'label': 'Stores', 'url': path(['index'])}]) %}
{% set breadcrumbs = breadcrumbs|merge([{'label': model.name, 'url': path('view', {'id': model.uid})}]) %}
{% set breadcrumbs = breadcrumbs|merge(['Update']) %}
{{ set(this, 'params', this.params|merge({'breadcrumbs': breadcrumbs})) }}
<div class="stores-update">
    <div class="content-wrapper">
        <section class="account-padding view-list view-current">
            <div class="row">
                {% if store %}
                    <div class="col-md-12">

                        <div class="stores-form">
                            {% set form = active_form_begin({'options' : {'enctype' : 'multipart/form-data'}}) %}
                            <p class="title first">Основная информация</p>
                            <div class="edit_wrapper">
                                <div class="edit_blk">
                                    <p><span>UID:</span> {{store.uid}}</p>
                                    <p><span>Добавлен:</span> {{store.added}}</p>
                                    <p><span>Посещений:</span> {{store.visit}}</p>
                                    <p><span>Картчка магазина:</span> <a href="/stores/{{store.routeUrl}}" target="_blank" rel="nofollow noopener">перейти</a></p>
                                    <p><span>Название:</span> <br>{{ form.field(model, 'name').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Route:</span> <br>{{ form.field(model, 'route').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>URL:</span> <br>{{ form.field(model, 'url').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Дополнительные URL(через запятую):</span> <br>{{ form.field(model, 'url_alternative').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Акция</span> {{ form.field(model, 'action_id').dropDownList({'0' : '','1' : 'Двойной кэшбэк'}).label(false)|raw }}</p>
                                    {#<p><span>Рейтинг</span> {{ form.field(model, 'rating').textInput({'maxlength':true}).label(false)|raw }}</p>#}
                                    {#<p><span>Просчет рейтинга</span> {{ form.field(model, 'no_rating_calculate').dropDownList({'0' : 'Пересчитывать','1' : 'Не пересчитывать'}).label(false)|raw }}</p>#}
                                    <p><span>Отображать в задолбашках</span> {{ form.field(model, 'show_notify').dropDownList({'0' : 'Не отображать','1' : 'Отображать'}).label(false)|raw }}</p>
                                    <p><span>Отображать в блок посылок</span> {{ form.field(model, 'show_tracking').dropDownList({'0' : 'Не отображать','1' : 'Отображать'}).label(false)|raw }}</p>
                                    <p><span>Отслеживать переходы</span> {{ form.field(model, 'watch_transitions').dropDownList({'0' : 'Не отслеживать','1' : 'Отслеживать'}).label(false)|raw }}</p>
                                    <p><span>Регионы</span></p>
                                    <ul class="ch_tree">
                                        {% for region_item in model.regions %}
                                            <li>
                                                <label>
                                                    <input {% if region_item.checked %} checked {% endif %} type="checkbox" name="Stores[regions_list][]" value="{{region_item.code}}"><span>{{region_item.name}}</span>
                                                </label>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                    <p><span>Магазин активен:</span><br>
                                        {{ form.field(model, 'is_active').dropDownList({'-1' : 'Выключен','0' : 'Приостановлен','1' : 'Активен'}).label(false)|raw }}
                                    </p>

                                </div>
                                <div class="edit_blk">
                                    <p>
                                        <span>Logo:</span>
                                        <img for="Stores[logoImage]" style="max-height: 150px;" src="images/logos/{{ model.logo | raw }}">
                                    </p>
                                    {{ form.field(model, 'logoImage').fileInput().label(false)|raw }}
                                    <p><span>Валюта:</span> <br> {{ form.field(model, 'currency').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Отображаемый cashback:</span> <br>{{ form.field(model, 'displayed_cashback').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Отображаемое время холда (дней):</span> <br>{{ form.field(model, 'hold_time').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Процент отдаваемый от нашей выгоды:</span> <br>{{ form.field(model, 'percent').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Тип магазина:</span><br>
                                        {{ form.field(model, 'is_offline').dropDownList({'0' : 'Онлайн','1' : 'Оффлайн'}).label(false)|raw }}
                                    </p>
                                    <p><span>Наличие чека</span> {{ form.field(model, 'cash_number').dropDownList({'0' : 'Обязателен','1' : 'Отсутствует'}).label(false)|raw }}</p>
                                    <p><span>Связанный магазин(ID, связка онлайн-оффлайн):</span> <br>{{ form.field(model, 'related').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Магазины торговой сети (ID через запятую):</span> <br>{{ form.field(model, 'related_stores').textInput({'maxlength':true}).label(false)|raw }}</p>
                                    <p><span>Название торговой сети:</span> <br>{{ form.field(model, 'network_name').textInput({'maxlength':true}).label(false)|raw }}</p>

                                </div>
                            </div>
                            <p><span>Alias:</span> <br>{{ form.field(model, 'alias').textarea({'maxlength':true}).label(false)|raw }}</p>

                            <p class="title first">Локальная информация</p>
                            <div class="tarif_select_blk">
                                <input type="radio" class="controls_option" value="ru-RU" checked id="option_tab_ru-RU"
                                       name="tabs_open">
                                {% for k,lang in languages %}
                                    <input type="radio" class="controls_option" value="{{ k }}" id="option_tab_{{ k }}"
                                           name="tabs_open">
                                {% endfor %}
                                <ul class="tab_control">
                                    <li class="tab_butt_ru-RU">
                                        <label for="option_tab_ru-RU">
                                            <img src="/images/flag/ru-RU.svg" height="12px">
                                            Русский
                                        </label>
                                    </li>
                                    {% for k,lang in languages %}
                                        <li class="tab_butt_{{ k }}">
                                            <label for="option_tab_{{ k }}">
                                                <img src="/images/flag/{{ k }}.svg" height="12px">
                                                {{ lang.name }}
                                            </label>
                                        </li>
                                    {% endfor %}
                                </ul>

                                <div class="content_tab">
                                    <div class="cpa_box tab_ru-RU">
                                        <p><span>Название по русски:</span> <br>
                                            {{ form.field(model, 'local_name').textInput({'maxlength':true}).label(false)|raw }}
                                        </p>
                                        <p><span>Контакты. Имя:</span> <br>
                                            {{ form.field(model, 'contact_name').textInput({'maxlength':true}).label(false)|raw }}
                                        </p>
                                        <p><span>Контакты. Телефон:</span> <br>
                                            {{ form.field(model, 'contact_email').textInput({'maxlength':true}).label(false)|raw }}
                                        </p>
                                        <p><span>Контакты. E-mail:</span> <br>
                                        {{ form.field(model, 'contact_phone').textInput({'maxlength':true}).label(false)|raw }}
                                        </p>
                                        <p>
                                            <span>Дополнительное описание:</span> <br>
                                            {{ form.field(model, 'description_extend').textInput({'maxlength':true}).label(false)|raw }}
                                        </p>
                                        <p>
                                            <span>Краткое описание  (Информация о  ...):</span> <br>
                                            {{ form.field(model, 'short_description').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                        </p>
                                        <p>
                                            <span>Описание  (Информация о кэшбэк в ...):</span><br>
                                            {{ form.field(model, 'description').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                        </p>
                                        <p>
                                            <span>Специальные условия  (Дополнительная информация):</span> <br>
                                            {{ form.field(model, 'conditions').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                        </p>
                                        <p>
                                            <span>Текст для активных купонов:</span> <br>
                                            {{ form.field(model, 'coupon_description').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                        </p>
                                    </div>
                                    {% for k,lang in languages %}
                                        <div class="cpa_box tab_{{ k }}">
                                            <p><span>Название:</span> <br>
                                                {{ form.field(lang.model, 'local_name').textInput({'maxlength':true}).label(false)|raw }}
                                            </p>
                                            <p><span>Контакты. Имя:</span> <br>
                                                {{ form.field(lang.model, 'contact_name').textInput({'maxlength':true}).label(false)|raw }}
                                            </p>
                                            <p><span>Контакты. Телефон:</span> <br>
                                                {{ form.field(lang.model, 'contact_email').textInput({'maxlength':true}).label(false)|raw }}
                                            </p>
                                            <p><span>Контакты. E-mail:</span> <br>
                                                {{ form.field(lang.model, 'contact_phone').textInput({'maxlength':true}).label(false)|raw }}
                                            </p>
                                            <p>
                                                <span>Дополнительное описание:</span> <br>
                                                {{ form.field(lang.model, 'description_extend').textInput({'maxlength':true}).label(false)|raw }}
                                            </p>
                                            <p>
                                                <span>Краткое описание  (Информация о  ...):</span> <br>
                                                {{ form.field(lang.model, 'short_description').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                            </p>
                                            <p>
                                                <span>Описание  (Информация о кэшбэк в ...):</span><br>
                                                {{ form.field(lang.model, 'description').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                            </p>
                                            <p>
                                                <span>Специальные условия  (Дополнительная информация):</span> <br>
                                                {{ form.field(lang.model, 'conditions').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                            </p>
                                            <p>
                                                <span>Текст для активных купонов:</span> <br>
                                                {{ form.field(lang.model, 'coupon_description').widget(TinyMce.className(),params('TinyMce')).label(false)|raw }}
                                            </p>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>


                            {#{{ form.field(model, 'video').widget(MultipleInput.className(), {#}
                                {#'allowEmptyList':true,#}

                            {#})|raw }}#}
                            <br>

                            {{ form.field(model, 'videos').widget(MultipleInput.className(), {
                                'allowEmptyList':true,
                                'columns': [
                                    {
                                        'name': 'video',
                                        'title': 'Видео',
                                    },
                                    {
                                        'name': 'title',
                                        'title': 'Текст',
                                    }
                                ]


                            })|raw }}

                            <input type="hidden" name="type" value="update_main_information">

                            <div class="row">
                                <div class="col-md-12">
                                    <p class="title">
                                        Рейтинг по регионам
                                    </p>
                                </div>
                                {% for rating in ratings %}
                                    <div class="col-md-12">
                                        <div class="col-md-2">
                                            {{ rating.region_name }}
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group ">
                                                <label for="stores-rating-{{ rating.region_code }}">Рейтинг</label>
                                                <input type="text" id="stores-rating-{{ rating.region_code }}" class="form-control" name="StoreRatings_{{ rating.region_code }}[rating]" value="{{ rating.model.rating }}" maxlength="255" aria-required="true">
                                                <div class="help-block"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <div class="form-group ">
                                                <label for="stores-rating-no-calculate-{{ rating.region_code }}">Просчет рейтинга</label>
                                                <select id="stores-rating-no-calculate-{{ rating.region_code }}" class="form-control" name="StoreRatings_{{ rating.region_code }}[no_calculate]">
                                                    <option value="0" {% if rating.model.no_calculate == 0 %}selected{% endif %} >Пересчитывать</option>
                                                    <option value="1" {% if rating.model.no_calculate == 1 %}selected{% endif %} >Не пересчитывать</option>
                                                </select>
                                                <div class="help-block"></div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="form-group">
                                <button type="submit" class="{{ model.isNewRecord ? "btn btn-success" : "btn btn-primary" }}">{{ model.isNewRecord ? 'Create' : 'Сохранить' }}</button>
                            </div>


                            {{ active_form_end() }}

                            {% include('outstand_cpa_loader.twig') %}

                            <p class="title">Тарифы</p>

                            <div class="tarif_select_blk">
                                {% if tariffs|length > 0 %}
                                    {% for tariff in tariffs %}
                                        {% include 'store/tab_head_suf.twig' %}
                                    {% endfor %}
                                {% endif %}
                                <ul class="tab_control ajax_save" uid="{{store.uid}}" save_url="/admin/stores/ajax_save/active_cpa">
                                    {% if tariffs|length > 0 %}
                                        {% for tariff in tariffs %}
                                            {% include 'store/tab_head_but.twig' %}
                                        {% endfor %}
                                    {% endif %}
                                    <li class="add_button">
                                        Добавить CPA
                                        <ul>
                                            {% for cpa in cpa_list %}
                                                <li code="{{cpa.id}}" parent="{{store.uid}}" class="add_shop_element" mode="cpa">{{cpa.name}}</li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                </ul>
                                <div class="content_tab">
                                    {% if tariffs|length > 0 %}
                                        {% for tariff in tariffs %}
                                            {% include 'store/tab_body.twig' %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            <p class="title">
                            Фотографии магазина
                            </p>
                            <div>
                                {% set form = active_form_begin({'options' : {'enctype' : 'multipart/form-data'}}) %}

                                    {{ FileInput_widget({
                                        'name':'photo_input',
                                        'url' : {0:'/stores/admin/fileapi-upload','id':model.uid},
                                        'removeUrl' : {0:'/stores/admin/fileapi-remove','id':model.uid},
                                        'value':model.photoList
                                    }) | raw }}

                                {{ active_form_end() }}
                            </div>



                            {% if categories|length > 0 %}
                                <p class="title">
                                    Категории магазина
                                    {% if related %}
                                    <a
                                            class="btn btn-primary ajax-confirm"
                                            style="float: right;font-size: 12px;padding: 3px 10px;"
                                            data-question="Хотите импортировать все категории из {{ related.name }} ({{ related.uid }})?
                                                            <br>Все текущие категории будут очищенны."
                                            data-store="{{ store.uid }}"
                                    >Копировать из {{ related.name }} ({{ related.uid }})</a>
                                    {% endif %}
                                </p>
                                <form method="post" action="/admin/stores/update?id={{store.uid}}" name="categories-edit-stores">
                                    <ul class="ch_tree">
                                        {% for category in categories %}
                                            <li>
                                                <label>
                                                    <input {% if category.uid in store_categories %} checked {% endif %} data-uid="{{category.uid}}" data-parent-id="{{category.parent_id}}" type="checkbox" name="category_id[]" value="{{category.uid}}"><span>{{category.name}}</span>
                                                </label>
                                                {% if category.childrens|length > 0 %}
                                                    <ul>
                                                        {% for category_ch in category.childrens %}
                                                            <li>
                                                                <label>
                                                                    <input {% if category_ch.uid in store_categories %} checked {% endif %} data-uid="{{category_ch.uid}}" data-parent-id="{{category_ch.parent_id}}" type="checkbox" name="category_id[]" value="{{category_ch.uid}}"><span>{{category_ch.name}}</span>
                                                                </label>
                                                            </li>
                                                        {% endfor %}
                                                    </ul>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                        <input type="hidden" name="id" value="{{store.uid}}">
                                        <input type="hidden" name="type" value="update_categories">
                                        <button type="submit">Изменить</button>
                                    </ul>
                                </form>
                            {% endif %}
                            {% if store.storesPoints|length > 0%}
                                <p class="title">Точки продаж</p>
                                <table class="stores-form__stores-points_table">
                                    <thead>
                                    <tr>
                                        <th></th>
                                        <th>Название</th>
                                        <th>Адрес</th>
                                        <th>Время работы</th>
                                        <th>Телефон</th>
                                    </tr>
                                    </thead>
                                    {% for store_point  in store.storesPoints %}
                                        <tr class="stores-form__stores-points_row">
                                            <th>{{ loop.index }}.</th>
                                            <th>
                                                {{ store_point.name }}
                                            </th>
                                            <th> {{ store_point.country }}, {{ store_point.city }}, {{ store_point.address }}</th>
                                            <th>
                                                {% set work_times = store_point.work_time_details %}
                                                {% include('parts/work_time.twig')%}
                                            </th>
                                            <th>{{ store_point.phone }}</th>
                                        </tr>
                                    {% endfor %}
                                </table>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="col-md-12">
                            <div class="not-found">Магазин не найден.</div>
                        </div>
                    {% endif %}
                </div>
            </div>

        </section>
    </div>
</div>
<style>
    ul.tab_control li label {
        cursor: pointer;
    }

    #option_tab_ru-RU:checked ~ ul .tab_butt_ru-RU {
        background: #fbcf4a;
    }

    #option_tab_ru-RU:checked ~ .content_tab .tab_ru-RU {
        display: block;
    }

    #option_tab_ru-RU:checked {
        color: #000;
    }

    {% for k,lang in languages %}
    #option_tab_{{ k }}:checked ~ ul .tab_butt_{{ k }} {
        background: #fbcf4a;
    }

    #option_tab_{{ k }}:checked ~ .content_tab .tab_{{ k }} {
        display: block;
    }

    #option_tab_{{ k }}:checked {
        color: #000;
    }

    {% endfor %}
</style>