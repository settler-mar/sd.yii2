<?php

namespace frontend\modules\stores\controllers;

use frontend\modules\sdblog\models\Posts;
use yii;
use frontend\components\SdController;
use frontend\modules\stores\models\Stores;
use frontend\modules\reviews\models\Reviews;
use frontend\modules\coupons\models\Coupons;
use frontend\modules\stores\models\CategoriesStores;
use frontend\modules\favorites\models\UsersFavorites;
use frontend\components\Pagination;
use frontend\modules\slider\models\Slider;
use frontend\models\RouteChange;
use b2b\modules\stores_points\models\B2bStoresPoints;


class DefaultController extends SdController
{

  /**
   * Переопределяем для stores
   * @var array
   */
  public $limitVars = [24, 48, 96];
  /**
   * переопределяем для stores
   * @var int
   */
  public $defaultLimit = 48;


  public $offline = false;

  /**
   * @param string $id
   * @return null|yii\base\Action
   */
  public function createAction($id)
  {
    $request = \Yii::$app->request;
    //здесь могут быть редиректы со старых роутов, поэтому делаем проверку для параметров старых роутов
    //передаваемых в запросе быть не должно
    $this->checkWrongParams(['store', 'expired', 'coupon', 'id']);
    $category = $request->get('category');

    if ($category) {
      $this->routeRedirects($category);
      exit;
    }

    if ($id) {
      if ($id == 'data') {
          echo $this->actionData();
          exit;
      }
      if ($id == 'abc') {
        \Yii::$app->params['url_mask'] = 'stores/abc';
        echo $this->actionAbc();
        exit;
      }
      //имеется action, который должен быть категорией или магазином, ищем такую
      //если в конце категории или шопа слово -offline
      $this->offline = substr($id, strlen($id) - strlen('-offline')) == '-offline';


      $store = Stores::byRoute($id);
      if ($store) {
        //есть магазин
        //$this->Params($request->get(), ['page']);
        $cpaLink = $store->cpaLink;
//        if ($cpaLink && $cpaLink->cpa_id == 2) {
//          //online-offline шоп, для поиска мететегов добавляем в url-mask
//          \Yii::$app->params['url_mask'] = $request->pathInfo . '/online';
//        }
        \Yii::$app->params['url_mask'] = 'stores/*' .
            ($cpaLink && $cpaLink->cpa_id == 1 ? '/online' : '') .
            ($this->offline ? '/offline' : '');

        $this->checkParams('store');
        echo $this->actionStore($store);
        exit;
      }

      /*ddd($id);
      ddd($this->offline);*/
      if (($id == 'favorite' || $id == "favorite-offline") && !Yii::$app->user->isGuest) {
        \Yii::$app->params['category_menu_item'] = $id;
        //ddd($id);
        echo $this->actionIndex(str_replace('-offline', '', $id));
        exit;
      }

      $categoryStore = CategoriesStores::byRoute($id);
      if ($categoryStore) {
        //если есть категория
        \Yii::$app->params['url_mask'] = 'stores/category/*' . ($this->offline ? '/offline' : '');
        echo $this->actionIndex($id, $categoryStore);
        exit;
      };

      //если нет категории или магазина
      //найти в удалённых шопах
      $newRoute = RouteChange::getNew($id, RouteChange::ROUTE_TYPE_STORES);
      if ($newRoute) {
        //если есть новый роут для удалённого, делаем редирект
        $this->redirect('/stores/' . $newRoute, 301)->send();
        exit;
      };
      throw new \yii\web\NotFoundHttpException;
    }
    return parent::createAction($id); // TODO: Change the autogenerated stub
  }

  /**
   * @return string
   * @throws yii\web\NotFoundHttpException
   */
  public function actionIndex($actionId = '', $categoryStore = null)
  {
    $request = Yii::$app->request;

    $page = $request->get('page');
    $limit = $request->get('limit');
    $sort = $request->get('sort');
    $offline = $request->get('offline') || $this->offline;
    $storeFrom = $request->get('w');

    $sortvars = Stores::sortvarItems($offline);
    $defaultSort = Stores::defaultSort($sortvars);

    $validator = new \yii\validators\NumberValidator();
    $validatorIn = new \yii\validators\RangeValidator(['range' => array_keys($sortvars)]);
    if (!empty($limit) && !$validator->validate($limit) ||
        !empty($sort) && !$validatorIn->validate($sort)
    ) {
      throw new \yii\web\NotFoundHttpException;
    };

    $sort = (!empty($sort)) ? $sort : $defaultSort;
    $limit = (!empty($limit)) ? $limit : $this->defaultLimit;
    $order = !empty($sortvars[$sort]['order']) ? $sortvars[$sort]['order'] : 'DESC';

    if (Yii::$app->params['stores_menu_separate'] == 1) {
      $this->params['breadcrumbs'][] = ['label' => ($offline ? 'Оффлайн-магазины' : 'Магазины'), 'url' => '/stores' . ($offline ? '/offline' : '')];
    } else {
      $this->params['breadcrumbs'][] = ['label' => 'Магазины', 'url' => '/stores'];
    }

    if ($offline) {
      if (!isset(Yii::$app->params['stores_menu_separate']) || Yii::$app->params['stores_menu_separate'] == 0) {
        $url = isset(Yii::$app->params['offline_redirect']) ? Yii::$app->params['offline_redirect'] : "/stores/stores-offline";
        $this->redirect($url, 307)->send();
        exit;
      }
      //$this->params['breadcrumbs'][] = ['label' => 'Оффлайн', 'url' => '/stores/offline'];
    }

    $storesData = [];
    $dataBaseData = Stores::items()
        ->addSelect([
            "substr(displayed_cashback, locate(' ', displayed_cashback)+1, locate('%', displayed_cashback)" .
            " - locate(' ', displayed_cashback) -1) + 0 as  cashback_percent",
            "substr(displayed_cashback, locate(' ', displayed_cashback)+1, length(displayed_cashback)" .
            " - locate(' ', displayed_cashback) - locate('%', displayed_cashback)) + 0 as cashback_summ",
        ])
        ->orderBy($sort . ' ' . $order);
    $cacheName = 'catalog_stores_' . $page . '_' . $limit . '_' . $sort . '_' . $order .($storeFrom ? '_from_'.$storeFrom : '') ;

    if ($categoryStore) {
      //категория магазина
      $category = $categoryStore->uid;
      $storesData['current_category'] = $categoryStore->attributes;//CategoryStores::byId($category);
      if ($categoryStore->is_active == 0) {
        $this->redirect('/stores', 301)->send();
        exit;
      }

      //чтобы виджет мог получить current_category_id в main.twig
      \Yii::$app->controller->current_category_id = $category;
      $this->params['breadcrumbs'][] = [
          'label' => $categoryStore['name'],
          'url' => '/stores/' . $categoryStore->route,
      ];

      $dataBaseData->innerJoin('cw_stores_to_categories cstc', 'cws.uid = cstc.store_id')
          ->andWhere(['cstc.category_id' => $category]);

      $cacheName .= '_' . $category;
    }

    // дополнительно как категории шопов в меню - избранные
    $categoryMenuItem = isset(\Yii::$app->params['category_menu_item']) ? \Yii::$app->params['category_menu_item'] : null;

    if ($categoryMenuItem == 'favorite' || $categoryMenuItem == 'favorite-offline') {
      $storesData['current_category'] = CategoriesStores::find()
          ->where(['route' => 'favorite'])
          ->asArray()
          ->one();

      $cacheName .= '_favorites_' . Yii::$app->user->id;
      $url = '/stores/favorite';

      $dataBaseData->innerJoin(UsersFavorites::tableName() . ' cuf', 'cws.uid = cuf.store_id')
          ->andWhere(["cuf.user_id" => \Yii::$app->user->id]);

      $this->params['breadcrumbs'][] = [
          'label' => 'Мои избранные',
          'url' => $url,
      ];
    }


    if ($actionId == "") {
      $storesData['current_category'] = CategoriesStores::find()
          ->where(['route' => '/'])
          ->asArray()
          ->one();
    };



    if (Yii::$app->params['stores_menu_separate'] == 1) {
      $cacheName .= $offline ? '_offline' : '_online';
      $dataBaseData->andWhere(['cws.is_offline' => $offline ? 1 : 0]);
    }
    if ($storeFrom) {
        //алфавитный поиск
        if ($storeFrom == '0‑9') {
            $dataBaseData->andWhere(['or',
                ['like', 'cws.name', '0%', false],
                ['like', 'cws.name', '1%', false],
                ['like', 'cws.name', '2%', false],
                ['like', 'cws.name', '3%', false],
                ['like', 'cws.name', '4%', false],
                ['like', 'cws.name', '5%', false],
                ['like', 'cws.name', '6%', false],
                ['like', 'cws.name', '7%', false],
                ['like', 'cws.name', '8%', false],
                ['like', 'cws.name', '9%', false],
            ]);
        } else {
            $dataBaseData->andWhere(['like', 'cws.name', $storeFrom.'%', false]);
        }
        $this->params['breadcrumbs'][] = [
            'label' => $storeFrom,
            'url' => '/stores'. ($categoryStore ? '/' . $categoryStore->route : '') .'?w=' .  $storeFrom,
        ];
    }
    if ($page > 1) {
       $this->params['breadcrumbs'][] = 'Страница ' . $page;
    }


    $pagination = new Pagination(
        $dataBaseData,
        $cacheName,
        ['limit' => $limit, 'page' => $page]
    );

    $storesData['stores'] = $pagination->data();
    $storesData["total_v"] = $pagination->count();
    $storesData["show_stores"] = count($storesData['stores']);
    $storesData["offset_stores"] = $pagination->offset();
    $storesData["total_all_stores"] = Stores::activeCount();
    $storesData["total_all_coupon"] = Coupons::activeCount();
    $storesData["page"] = empty($page) ? 1 : $page;
    $storesData["limit"] = empty($limit) ? $this->defaultLimit : $limit;

    $paginateParams = [
        'limit' => $this->defaultLimit == $limit ? null : $limit,
        'sort' => $defaultSort == $sort ? null : $sort,
        'page' => $page,
        'offline' => $offline ? 1 : null,
        'w' => $storeFrom ? $storeFrom : null,
    ];

    $paginatePath = '/' . ($actionId ? $actionId . '/' : '') . 'stores';
    if ($pagination->pages() > 1) {
      $storesData["pagination"] = $pagination->getPagination($paginatePath, $paginateParams);
      $this->makePaginationTags($paginatePath, $pagination->pages(), $page, $paginateParams);
    }

    $storesData['sortlinks'] =
        $this->getSortLinks($paginatePath, $sortvars, $defaultSort, $paginateParams);
    $storesData['limitlinks'] =
        $this->getLimitLinks($paginatePath, $defaultSort, $paginateParams);

    $storesData['slider'] = Slider::get();
    $storesData['offline'] = $offline ? 1 : (Yii::$app->params['stores_menu_separate'] == 1 ? 0 : null);

    if ($storesData['current_category'] && $storesData['current_category']['route'] != '/') {
      $storesData['coupons'] = Coupons::top([
          'store_category' => $storesData['current_category']['uid'],
          'offline' => $this->offline ? 1 : 0,
          'limit' => 4
          //'unique_store' => true,
      ]);
    }

    $storesData['posts'] = Posts::getLastPosts(['limit'=>3]);
    $storesData["stores_abc"] = Stores::getActiveStoresByAbc([
        'char_list_only'=> true,
        'category_id' => isset($category) ? $category : false,
        'offline' => $offline,
        'favorites' => $categoryMenuItem == 'favorite' || $categoryMenuItem == 'favorite-offline',
    ]);
    $storesData['stores_abc_w'] = $storeFrom ? $storeFrom : null;

    $storesData["favorites_link"] = $categoryMenuItem == 'favorite' || $categoryMenuItem == 'favorite-offline' ?
        '/favorite' : '';
    $storesData["users_reviews"] = Reviews::top();

    return $this->render('catalog', $storesData);
  }

  /**
   * @param $id
   * @return string
   * @throws yii\web\NotFoundHttpException
   */
  private function actionStore($store)
  {
    if (
        $store->is_active < 0 &&
        (Yii::$app->user->isGuest || !Yii::$app->user->can('ShopView'))
    ) {
      $this->redirect('/stores', 301)->send();
      exit();
    }

    $contentData["current_store"] = $store;
    $contentData["current_store.description"] = htmlspecialchars_decode($store->description);

    $contentData["store_reviews"] = Reviews::byStoreId($store->uid);
    $contentData["store_rating"] = Reviews::storeRating($store->uid);

    $contentData["coupons"] = Coupons::top(['store' => $store->uid, 'limit' => 4]);
    $contentData["coupons_counts"] = Coupons::counts($store->uid);
    $contentData["all_coupons_counts"] = Coupons::counts();
    $additionalStores = $this->getAdditionals($store);
    $contentData["additional_stores"] = $additionalStores['additional_stores'];
    $contentData["additional_stores_category"] = $additionalStores['additional_stores_category'];

    $contentData['store_points'] = B2bStoresPoints::byStoreId($store->uid);

    $contentData["curs"] = Yii::$app->conversion->options();

    Yii::$app->view->metaTags[] = '<meta property="og:image" content="https://secretdiscounter.ru/images/logos/' . $store->logo . '" />';
    $contentData['wrap'] = 'index';
    Yii::$app->params['global_bg'] = "tablets_flex-col";
    $contentData['referrer_category'] = $this->referrerCategory();

    return $this->render('shop', $contentData);
  }

  private function actionAbc()
  {
    $offline = Yii::$app->request->get('offline') || $this->offline;

    //$this->params['breadcrumbs'][] = ['label' => 'Магазины', 'url'=>'/stores'];
    $this->params['breadcrumbs'][] = ['label' => ($offline ? 'Оффлайн-магазины' : 'Магазины'), 'url' => '/stores' . ($offline ? '/offline' : '')];
    $this->params['breadcrumbs'][] = ['label' => 'Алфавитный поиск'];
    $contentData['offline'] = $offline ? 1 : (Yii::$app->params['stores_menu_separate'] == 1 ? 0 : null);

    $contentData["stores_abc"] = Stores::getActiveStoresByAbc(['offline' => $offline]);
    $contentData["total_v"] = Stores::activeCount(['is_offline' => $offline]);
    $contentData['posts'] = Posts::getLastPosts();

    return $this->render('abc', $contentData);
  }

  /**
   * Get a list of additional stores
   * @param string $route
   * @return array
   */
  private function getAdditionals($store)
  {
    //вычисляем, не пришёл ли пользователь из категории
    $referrer = \Yii::$app->request->referrer;
    $category = false;
    if ($referrer && strpos($referrer, '/stores/')) {
      $path = explode('/', $referrer);
      $pos = array_search('stores', $path);
      if (isset($path[$pos + 1])) {
        $category = CategoriesStores::byRoute($path[$pos + 1]);
      }
    }

    $cache = Yii::$app->cache;
    $dependency = new yii\caching\DbDependency;
    $dependencyName = 'additional_stores';
    $dependency->sql = 'select `last_update` from `cw_cache` where `name` = "' . $dependencyName . '"';
    if (!$category) {
      //если нет категории
      $additional_stores = $cache->getOrSet('additional_stores_except_' . $store->uid, function () use ($store) {
        return Stores::items()
            ->andWhere(['<>', 'cws.uid', $store->uid])
            ->andWhere(['cws.is_offline' => $store->is_offline])
            ->orderBy('rating DESC')
            ->limit(6)
            ->all();
      }, $cache->defaultDuration, $dependency);
    } else {
      //категория есть
      $additional_stores = $cache->getOrSet(
          'additional_stores_by_categories_' . $category->uid . '_except_' . $store->uid,
          function () use ($category, $store
          ) {
            return Stores::items()
                ->innerJoin('cw_stores_to_categories cwstc', 'cws.uid = cwstc.store_id')
                ->andWhere(['<>', 'cws.uid', $store->uid])
                ->andWhere(['cwstc.category_id' => $category->uid])
                ->orderBy('rating DESC')
                ->limit(6)
                ->all();
          },
          $cache->defaultDuration,
          $dependency
      );
    };
    return [
        'additional_stores' => $additional_stores,
        'additional_stores_category' => $category,
    ];
  }

  /**
   * @param $store
   * @throws \yii\web\NotFoundHttpException
   * из маршрутизации "по-старому" перенаправления на "по-новому"
   */
  private function routeRedirects($store)
  {
    $parent = CategoriesStores::byId($store);
    if (!$parent || $parent->is_active == 0) {
      throw new \yii\web\NotFoundHttpException;
    }
    $this->redirect('/stores/' . $parent->route, 301)->send();
    exit;
  }

    /**
     * не пришли ли в шоп из категории?
     * @return mixed|null
     */
  private function referrerCategory()
  {
     $referrer  = Yii::$app->request->referrer;
     if (empty($referrer)) {
         return null;
     }
     preg_match('/\/stores\/(.+)\?/', $referrer, $m);
     if (!empty($m[1])) {
         return CategoriesStores::byRoute($m[1]);
     }
     return null;
  }

  public function actionData()
  {
      $cache = \Yii::$app->cache;
      $cacheName = 'stores_plugin_data';

      $data = $cache->getOrSet($cacheName, function(){

//          $storeCategories = CategoriesStores::find()
//              ->from(CategoriesStores::tableName().' cwcs')
//              ->select(['cwstc.store_id', 'cwcs.route'])
//              ->innerJoin('cw_stores_to_categories cwstc', 'cwstc.category_id = cwcs.uid')
//              ->groupBy(['cwstc.store_id']);

          $stores = Stores::find()
              //->select(['cws.url', 'cws.name', 'cws.route as store_route', 'cws.action_id', 'cws.currency', 'cws.displayed_cashback', 'cwsc.route as category_route'])
              ->select(['cws.uid', 'cws.url', 'cws.name', 'cws.route as store_route', 'cws.action_id', 'cws.currency', 'cws.displayed_cashback'])
              ->from(Stores::tableName(). ' cws')
              //->leftJoin(['cwsc' => $storeCategories], 'cwsc.store_id = cws.uid')
              ->where(['cws.is_active'=> '1'])
              ->asArray()
              //->limit(10)
              ->all();
          $data = [
              //"text" => "Сэкономьте {{cashback}} в {{currentUrl}} с SecretDiscounter",
              "text" => 'Сэкономьте {{cashback}} в <span class="secretdiscounter-extension__here">{{storename}}</span> с SecretDiscounter',
              "searchtext" => "Кэшбэк {{cashback}}",
              "stores" => $stores,
          ];
          return $data;

      });
      //\Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;
      header('Access-Control-Allow-Origin: *');
      header('Content-Type: application/json');
      return json_encode($data);
  }


}

