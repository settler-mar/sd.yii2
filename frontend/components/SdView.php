<?php
namespace frontend\components;

use common\components\SdViewBASE;
use frontend\modules\favorites\models\UsersFavorites;
use frontend\modules\users\models\Users;
use Yii;
use yii\db\Query;
use yii\web\View;
use yii\helpers\Url;
use frontend\modules\meta\models\Meta;
use yii\twig\ViewRenderer;
use frontend\modules\reviews\models\Reviews;
use frontend\modules\payments\models\Payments;

class SdView extends SdViewBASE
{

  public $user_id = false;
  public $user = [];
  public $balance = [];
  public $site_rating = null;
  public $isWebMaster = false;
  public $sd_counter;
  public $favorites = false;//количество изрбанных
  public $layout_mode = 'default';
  public $currency;

  public function init_param()
  {
    $this->first_init = false;
    $this->currency = Yii::$app->params['valuta'];

    if (!Yii::$app->user->isGuest) {
      $this->user_id = Yii::$app->user->id;
      $user = Yii::$app->user->identity;
      $this->currency = $user->currency;
      $this->user = (array)$user->getIterator();
      $this->balance = $user->getBalance();
      $this->favorites = $this->user_id ? UsersFavorites::userFavoriteCount($this->user_id) : false;

      $this->all_params['bonus_status'] = $user->bonus_status_data;
      $this->all_params['user'] = (array)$user->getIterator();
      $this->all_params['balance'] = $user->getBalance();
      $this->all_params['user_id'] = Yii::$app->user->id;

      if (!Yii::$app->user->isGuest/* && $user->bonus_status>0*/) {
        $bonus_list = Yii::$app->params['dictionary']['bonus_status'];
        if (isset($bonus_list[$user->bonus_status])) {
          $this->isWebMaster = isset($bonus_list[$user->bonus_status]['is_webmaster']) ?
              $bonus_list[$user->bonus_status]['is_webmaster'] : 0;
        }
      }
      $this->all_params['user_code'] = $user->barcode;
      $code_src = $user->barcodeImg;
      $this->all_params['user_code_img'] = $code_src;

      $this->all_params['fav_ids'] = UsersFavorites::getUserFav();

      $this->all_params['ref_id'] = '?r=' . $this->user_id;
    } else {
      $this->all_params['ref_id'] = '';
    }

    $cache = Yii::$app->cache;

    $this->all_params['sd_counter'] = Payments::counter();
    $this->sd_counter = $this->all_params['sd_counter'];

    $request = Yii::$app->request;

    if ($request->isAjax) {
      return;
    }
  }

  public function render($view, $params = [], $context = null)
  {
    if ($this->first_init) {
      $this->init_param();
    }

    if (!$this->site_rating) {
        $this->site_rating = Reviews::storeRating(0);
    }

    $this->all_params = array_merge($this->all_params, $params);
    if ($this->all_params && isset($this->all_params['exception'])) {
      Yii::$app->params['exception'] = $this->all_params['exception'];
    };
    Yii::$app->params['all_params'] = $this->all_params;

    if (isset(Yii::$app->request->get()['g']) && Yii::$app->request->get()['g']=='ajax_load') {
       Yii::$app->controller->layout = '@app/views/layouts/ajax_load.twig';
       //return parent::renderAjax($view, $this->all_params, $context);
    }

    return parent::render($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }

  public function renderAjax($view, $params = [], $context = null)
  {
    if ($this->first_init) {
      $this->init_param();
    }
    $this->all_params = array_merge($this->all_params, $params);
    Yii::$app->params['all_params'] = $this->all_params;
    return parent::renderAjax($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }
}