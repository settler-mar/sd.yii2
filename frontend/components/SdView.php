<?php
namespace frontend\components;

use Yii;
use yii\web\View;
use yii\helpers\Url;
use frontend\modules\meta\models\Meta;
use yii\twig\ViewRenderer;


class SdView extends View
{
  public $h1;
  public $contentBD;

  public $user_id = false;
  public $user = [];
  public $balance = [];

  public $all_params=[];

  public function init()
  {
    parent::init(); // TODO: Change the autogenerated stub
  }

  public function beforeRender($viewFile, $params)
  {
    if (!parent::beforeRender($viewFile, $params)) {
      return false;
    };

    if (!Yii::$app->user->isGuest) {
      $this->user_id = Yii::$app->user->id;
      $user = Yii::$app->user->identity;
      $this->user = (array)$user->getIterator();
      $this->balance = $user->getBalabce();

      $this->all_params['user']=$this->user;
      $this->all_params['balance']=$this->balance;
      $this->all_params['user_id']=$this->user_id;
    }

    $arr = $this->getPageMetadata();
    if (isset($arr['description'])) $this->metaTags[] = '<meta name="description" content="' . $arr['description'] . '">';
    if (isset($arr['keywords'])) $this->metaTags[] = '<meta name="keywords" content="' . $arr['keywords'] . '">';
    if (isset($arr['title'])) $this->title = $arr['title'];
    if (isset($arr['content'])) $this->contentBD = $arr['content'];
    if (isset($arr['h1'])) $this->h1 = $arr['h1'];
    return true;
  }

  /**
   * получение метаданных
   */
  private function getPageMetadata()
  {
    $request = Yii::$app->request;

    if ($request->isAjax || $request->isPost) {
      return;
    }

    $page = $request->pathInfo;

    if ($page == 'affiliate-system') {
      $page = 'account/affiliate';
    };
    if ($page == '') $page = 'index';

    $page_meta = Meta::find()
      ->select(['title', 'description', 'keywords', 'h1', 'content'])
      ->where(['page' => $page])
      ->asArray()
      ->all();

    if (count($page_meta) > 0) {
      $this->all_params=array_merge($this->all_params,$page_meta[0]);
      return $page_meta[0];
    }

    //прямого совпадения нет ищем по плейсхолдерам
    $arr = explode('/', $page);
    $page = false;
    if (count($arr) > 2) {
      $page = $arr[0] . '/' . $arr[1];
    } elseif (count($arr) > 1) {
      $page = $arr[0];
    }
    if ($page) {
      $mdataArray = Meta::find()
        ->select(['title', 'description', 'keywords', 'h1', 'content'])
        ->where(['like', 'page', $page . '/*', false])
        ->OrderBy(['page' => SORT_ASC])
        ->asArray()
        ->all();
      if (count($mdataArray) > 0) {
        $this->all_params=array_merge($this->all_params,$mdataArray[0]);
        return $mdataArray[0];
      }
    }

    //пробуем получитьт метотеги из параметров
    //Yii::$app->params['meta'] - искать тут
    return false;

    return $page_meta;
  }

  public function afterRender($viewFile, $params, &$output){

    $this->all_params=array_merge($this->all_params,$params);

    parent::afterRender($viewFile, $params, $output); // TODO: Change the autogenerated stub

    //Проставление переменных только когда рендорится слой layout
    if(
      strpos($viewFile,'layout')>0 &&
      (
        strpos($viewFile,'main.twig') ||
        strpos($viewFile,'account.twig')
      )
    ) {
      $output=Yii::$app->TwigString->render(
        $output,
        $this->all_params
      );
    }
  }
}