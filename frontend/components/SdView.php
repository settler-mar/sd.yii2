<?php
namespace frontend\components;

use common\components\SdViewBASE;
use frontend\modules\favorites\models\UsersFavorites;
use frontend\modules\users\models\Users;
use Yii;
use yii\db\Query;
use yii\web\View;
use yii\helpers\Url;
use frontend\modules\meta\models\Meta;
use yii\twig\ViewRenderer;
use frontend\modules\reviews\models\Reviews;
use frontend\modules\notification\models\Notifications;

class SdView extends SdViewBASE
{
  public $contentBD;

  public $user_id = false;
  public $user = [];
  public $balance = [];
  public $site_rating;
  public $isWebMaster = false;
  public $sd_counter;
  public $favorites = false;//количество изрбанных
  public $layout_mode = 'default';

  public function init_param()
  {
    $this->first_init = false;

    if (!Yii::$app->user->isGuest) {
      $this->user_id = Yii::$app->user->id;
      $user = Yii::$app->user->identity;
      $this->user = (array)$user->getIterator();
      $this->balance = $user->getBalance();
      $this->favorites = $this->user_id ? UsersFavorites::userFavoriteCount($this->user_id) : false;

      $this->all_params['bonus_status'] = $user->bonus_status_data;
      $this->all_params['user'] = (array)$user->getIterator();
      $this->all_params['balance'] = $user->getBalance();
      $this->all_params['user_id'] = Yii::$app->user->id;

      if (!Yii::$app->user->isGuest/* && $user->bonus_status>0*/) {
        $bonus_list = Yii::$app->params['dictionary']['bonus_status'];
        if (isset($bonus_list[$user->bonus_status])) {
          $this->isWebMaster = isset($bonus_list[$user->bonus_status]['is_webmaster']) ?
              $bonus_list[$user->bonus_status]['is_webmaster'] : 0;
        }
      }
      $this->all_params['user_code'] = $user->barcode;
      $code_src = $user->barcodeImg;
      $this->all_params['user_code_img'] = $code_src;

      $this->all_params['fav_ids'] = UsersFavorites::getUserFav();

      $this->all_params['ref_id'] = '?r=' . $this->user_id;
    } else {
      $this->all_params['ref_id'] = '';
    }

    $cache = Yii::$app->cache;
    //Грузим с кэша. Период очистки 8 часов.
    $this->all_params['sd_counter'] = $cache->getOrSet('counter_index', function () {
      $user_count = Users::find()->orderBy(['uid' => SORT_DESC])->asArray()->select('uid')->one();

      $sql = "SELECT max(cashback) as cashback, count(uid) as cnt 
      FROM `cw_payments` 
      WHERE `action_date` > '" . date("Y-m-d", time() - 1.1 * 24 * 60 * 60) . "'";
      $result2 = Yii::$app->db->createCommand($sql)->queryOne();

      $query = new Query();
      $query->select
      (['max(cashback) as cashback, count(uid) as cnt'])
          ->from('cw_payments')
          ->where(['>', 'action_date', date("Y-m-d", time() - 7 * 24 * 60 * 60)]);
      $command = $query->createCommand();
      $result = $command->queryOne();

      /*
            $query->select
            (['max(cashback) as cashback, count(uid) as cnt'])
                ->from('cw_payments')
                ->where(['>','action_date',date("Y-m-d",time()-3*24*60*60)]);
            $command   = $query->createCommand();
            $result2    = $command->queryOne();
      */
      $out = [
          'user_count' => round($user_count['uid'] * 5.4),
          'total_save' => round($user_count['uid'] * 302.4, 2),
          'count_save' => round($result['cnt'] * 112.4),
          'sum_save' => round($result2['cashback'] * 5.4, 2),
          'save_persent' => 39,
      ];

      return $out;
    }, 3600 * 8);
    $this->sd_counter = $this->all_params['sd_counter'];

    $request = Yii::$app->request;

    if ($request->isAjax) {
      return;
    }
  }

  public function render($view, $params = [], $context = null)
  {
    if ($this->first_init) {
      $this->init_param();
    }

    $this->site_rating = Reviews::storeRating(0);

    $this->all_params = array_merge($this->all_params, $params);
    if ($this->all_params && isset($this->all_params['exception'])) {
      Yii::$app->params['exception'] = $this->all_params['exception'];
    };
    Yii::$app->params['all_params'] = $this->all_params;

    if (isset(Yii::$app->request->get()['g']) && Yii::$app->request->get()['g']=='ajax_load') {
       Yii::$app->controller->layout = '@app/views/layouts/ajax_load.twig';
       //return parent::renderAjax($view, $this->all_params, $context);
    }

    return parent::render($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }

  public function renderAjax($view, $params = [], $context = null)
  {
    if ($this->first_init) {
      $this->init_param();
    }
    $this->all_params = array_merge($this->all_params, $params);
    Yii::$app->params['all_params'] = $this->all_params;
    return parent::renderAjax($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }
}