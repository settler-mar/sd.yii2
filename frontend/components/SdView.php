<?php
namespace frontend\components;

use frontend\modules\favorites\models\UsersFavorites;
use Yii;
use yii\web\View;
use yii\helpers\Url;
use frontend\modules\meta\models\Meta;
use yii\twig\ViewRenderer;


class SdView extends View
{
  public $h1;
  public $contentBD;

  public $user_id = false;
  public $user = [];
  public $balance = [];
  public $all_params=[];
  public $first_init= true;
  public $description;

  public function init_param()
  {
    $this->first_init=false;

    if (!Yii::$app->user->isGuest) {
      $this->user_id = Yii::$app->user->id;
      $user = Yii::$app->user->identity;
      $this->user = (array)$user->getIterator();
      $this->balance = $user->getBalance();

      $this->all_params['bonus_status'] = $user->bonus_status_data;
      $this->all_params['user']=$this->user;
      $this->all_params['balance']=$this->balance;
      $this->all_params['user_id']=$this->user_id;

      $this->all_params['fav_ids']=UsersFavorites::getUserFav();
    }

    $arr = $this->getPageMetadata();
    if($arr && is_array($arr)) {
      if (isset($arr['description'])) {
        $this->metaTags[] = '<meta name="description" content="' . $arr['description'] . '">';
        $this->description = $arr['description'];
      }
      if (isset($arr['keywords'])) $this->metaTags[] = '<meta name="keywords" content="' . $arr['keywords'] . '">';
      if (isset($arr['title'])) $this->title = $arr['title'];
      if (isset($arr['content'])) $this->contentBD = $arr['content'];
      if (isset($arr['h1'])) $this->h1 = $arr['h1'];

      $this->all_params = array_merge($this->all_params, $arr);
    }
  }

  public function render($view, $params = [], $context = null)
  {
    if($this->first_init){
      $this->init_param();
    }
    $this->all_params=array_merge($this->all_params,$params);
    return parent::render($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }

  public function renderAjax($view, $params = [], $context = null)
  {
    if($this->first_init){
      $this->init_param();
    }
    $this->all_params=array_merge($this->all_params,$params);
    return parent::renderAjax($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }


  /**
   * получение метаданных
   */
  private function getPageMetadata()
  {
    $request = Yii::$app->request;

    if ($request->isAjax || $request->isPost) {
      return false;
    }

    if(isset(Yii::$app->params['url_mask'])){
      $page=Yii::$app->params['url_mask'];
      $page=str_replace('default/','',$page);
      $page=str_replace('/default','',$page);
    }else {
      $page = $request->pathInfo;
    }

    if ($page == 'affiliate-system') {
      $page = 'account/affiliate';
    };
    if ($page == '') $page = 'index';

    $page_meta = Meta::find()
      ->select(['title', 'description', 'keywords', 'h1', 'content'])
      ->where(['page' => $page])
      ->asArray()
      ->one();

    if ($page_meta) {
      return $page_meta;
    }

    //прямого совпадения нет ищем по плейсхолдерам
    $arr = explode('/', $page);
    $page_t = false;
    if (count($arr) > 1) {
      unset($arr[count($arr)-1]);
      $page_t = implode('/', $arr) . '/';
    }
    if ($page_t) {
      $mdataArray = Meta::find()
        ->select(['title', 'description', 'keywords', 'h1', 'content'])
        ->where(['like', 'page', $page_t . '*', false])
        ->OrderBy(['page' => SORT_ASC])
        ->asArray()
        ->one();
      if ($mdataArray) {
        return $mdataArray;
      }
    }

    //пробуем получитьт метотеги из параметров
    $meta=Yii::$app->params['meta'];
    if(isset($meta[$page])){
      return $meta[$page];
    };

    //если ни чего не нашлось подходящего то возвращаем как для index
    return Yii::$app->params['meta']['index'];
  }

  public function afterRender($viewFile, $params, &$output){
    parent::afterRender($viewFile, $params, $output); // TODO: Change the autogenerated stub

    //Проставление переменных только когда рендорится слой layout
    if(
      strpos($viewFile,'layout')>0 &&
      (
        strpos($viewFile,'main.twig') ||
        strpos($viewFile,'account.twig')
      )
    ) {
      $output=Yii::$app->TwigString->render(
        $output,
        $this->all_params
      );
    }
  }
}