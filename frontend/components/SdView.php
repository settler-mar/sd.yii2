<?php
namespace frontend\components;

use frontend\modules\favorites\models\UsersFavorites;
use Yii;
use yii\web\View;
use yii\helpers\Url;
use frontend\modules\meta\models\Meta;
use yii\twig\ViewRenderer;


class SdView extends View
{
  public $h1;
  public $contentBD;

  public $user_id = false;
  public $user = [];
  public $balance = [];
  public $all_params=[];
  public $first_init= true;
  public $description;

  public function init_param()
  {
    $this->first_init=false;

    if (!Yii::$app->user->isGuest) {
      $this->user_id = Yii::$app->user->id;
      $user = Yii::$app->user->identity;
      $this->user = (array)$user->getIterator();
      $this->balance = $user->getBalance();

      $this->all_params['bonus_status'] = $user->bonus_status_data;
      $this->all_params['user']=(array)$user->getIterator();
      $this->all_params['balance']=$user->getBalance();
      $this->all_params['user_id']=Yii::$app->user->id;

      $this->all_params['fav_ids']=UsersFavorites::getUserFav();
    }

    $request = Yii::$app->request;

    if ($request->isAjax) {
      return ;
    }

    $arr = Meta::findByUrl($request->pathInfo);
    if($arr && is_array($arr)) {
      if (isset($arr['description'])) {
        $this->metaTags[] = '<meta name="description" content="' . $arr['description'] . '">';
        $this->description = $arr['description'];
      }
      if (isset($arr['keywords'])) $this->metaTags[] = '<meta name="keywords" content="' . $arr['keywords'] . '">';
      if (isset($arr['title'])) $this->title = $arr['title'];
      if (isset($arr['content'])) $this->contentBD = $arr['content'];
      if (isset($arr['h1'])) $this->h1 = $arr['h1'];

      $this->all_params = array_merge($this->all_params, $arr);
    }
  }

  public function render($view, $params = [], $context = null)
  {
    if($this->first_init){
      $this->init_param();
    }
    $this->all_params=array_merge($this->all_params,$params);
    return parent::render($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }

  public function renderAjax($view, $params = [], $context = null)
  {
    if($this->first_init){
      $this->init_param();
    }
    $this->all_params=array_merge($this->all_params,$params);
    return parent::renderAjax($view, $this->all_params, $context); // TODO: Change the autogenerated stub
  }


  public function afterRender($viewFile, $params, &$output){
    parent::afterRender($viewFile, $params, $output); // TODO: Change the autogenerated stub

    //Проставление переменных только когда рендорится слой layout
    if(
      strpos($viewFile,'layout')>0 &&
      (
        strpos($viewFile,'main.twig') ||
        strpos($viewFile,'account.twig')
      )
    ) {
      $output=Yii::$app->TwigString->render(
        $output,
        $this->all_params
      );
    }
  }
}