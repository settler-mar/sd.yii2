<?php
namespace frontend\components;

use Yii;
use yii\web\View;
use yii\helpers\Url;
use app\modules\meta\models\Meta;

class SdView extends View
{
 public $h1;
 public $contentBD;

 public function init()
 {
   parent::init(); // TODO: Change the autogenerated stub
   $this->registerJs('54');
 }

  public function beforeRender($viewFile, $params)
  {
   // ddd(Yii::$app->request->pathInfo);
    if (!parent::beforeRender($viewFile, $params)){
      return false;
    };

    /*
    $url=Url::current();
    $script_version=Yii::$app->params['scriptVersion'];
    $path_scripts=Yii::$app->params['pathToScript'];

    $path=trim($url,'/');
    $dir=explode('/',$path);
    $dir=$dir[0];
    if(isset($path_scripts[$dir])){
      $path_script=$path_scripts[$dir];
    }else{
      $path_script=$path_scripts['default'];
    }

    /* //прописываем js
    if(isset($path_script['js'])){
      foreach ($path_script['js'] as $js ){
        $js=str_replace('{{script_version}}',$script_version,$js);
        $this->registerJs($js);
      }
    }

    //прописываем стили
    if(isset($path_script['css'])){
      foreach ($path_script['css'] as $css ){
        $css=str_replace('{{script_version}}',$script_version,$css);
        $this->css[]=$css;
      }
    }*/


    /*d(Url::home(true));
    d(Url::current());
    d($this);
    d($viewFile);
    d($params);*/
    //ddd(explode('?', $_SERVER['REQUEST_URI'])[0]);
   // ddd($this->getPageMetadata());

    $arr = $this->getPageMetadata();
    //ddd($this->params);
    //$this->metaTags = $this->getPageMetadata();
    if (isset($arr['description'])) $this->metaTags[] = '<meta name="description" content="'.$arr['description'].'">';
    if (isset($arr['keywords'])) $this->metaTags[] = '<meta name="keywords" content="'.$arr['keywords'].'">';
    if (isset($arr['title'])) $this->title = $arr['title'];
    if (isset($arr['content'])) $this->contentBD = $arr['content'];
    if (isset($arr['h1'])) $this->h1 = $arr['h1'];

    //Yii::$app->view->params['contentFromBD'] = $arr['content'];
    //$this->params['h1TagFromBD'] = $arr['h1'];

    return true;
  }

  /**
   * получение метаданных
   */
  private function getPageMetadata()
  {
    $page = Yii::$app->request->pathInfo;
    $cacheType = "metadata";
    $cacheName = "metadata_" . $page;

    if($page=='affiliate-system'){
      $page='account/affiliate';
    };
    if ($page == '') $page = 'index';

      //вначале из базы
      $cache = Yii::$app->cache;

      $page_meta = $cache->getOrSet('page_meta', function ($page) {
        $meta = Meta::find()
          ->select(['title', 'description', 'keywords', 'h1', 'content'])
          ->where(['page' => $page])
          ->asArray()->all();
        return $meta;
      });

      ddd($page_meta);

      if (count($page_meta) > 0) {
        $page_meta = $page_meta[0];
      } else {
        //прямого совпадения нет ищем по плейсхолдерам
        $mdataArray = Meta::find()
          ->select('*')
       //   ->select('LENGTH(`page`)', 'l')
          ->where(['like','page','%*%'])
          ->OrderBy(['page'=>SORT_ASC])
          ->all();
        foreach ($mdataArray as $mdataItem) {
          $noalias = explode('*', $mdataItem->page);
          $match = '/^' . str_replace('/', '\/', $noalias[0]) . '.*' .
            str_replace('/', '\/', (!empty($noalias[1]) ? $noalias[1] : '')) . '$/';
          if (preg_match($match, $page)) {
            $page_meta = [
              'title' => $mdataItem->title,
              'description' => $mdataItem->description,
              'keywords' => $mdataItem->keywords,
              'h1' => $mdataItem->h1,
              'content' => $mdataItem->content,
            ];
            break;
          }
        }
       // if (!$mdata) {
          //если нет, то из настроек
      //    $mdata = \Cwcashback\Settings::call()->getSettings('metadata', $page);
       // }
      }

    //  if (\Cwcashback\Settings::call()->getSettings('env', 'cache')) {
      //  \Cwcashback\Memcache::addData(
        //  $cacheType,
          //$cacheName,
    //      $mdata,
      //    false,
        //  \Cwcashback\Settings::call()->getSettings('cachetime', 'month')
     //   );
     // }
    return $page_meta;
  }

}