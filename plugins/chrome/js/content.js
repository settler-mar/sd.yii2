function closeClick(){var e=this.getAttribute("data-store");storeUtil.setPopupClosed(e),document.querySelector(".secretdiscounter-extension").style.display="none"}function getUsers(){debug&&console.log("getusers"),chrome.runtime.sendMessage({action:"sd_xhttp",url:siteUrl+utils.href(userUrl)},function(e){debug&&console.log("getusers success",e);var t=!1;usersData=e,e.user?t=!!(usersData&&usersData.user&&usersData.user.language)&&usersData.user.language:e.language&&(t=e.language),t&&(language=t,userLanguage=t,Storage._loaded&&Storage.set(storageDataKeyLanguageCurrent,language))})}function changeFavorite(e){e.preventDefault();var t=this,a=t.getAttribute("data-id"),r=t.getAttribute("data-type");t.onclick=null,chrome.runtime.sendMessage({action:"sd_xhttp",method:"POST",url:siteUrl+utils.href(userFavoriteUrl),data:{affiliate_id:a,type:r}},function(e){if(t.onclick=changeFavorite,e&&!e.error){if("add"===r)usersData.user.favorites.push(a);else{var s=usersData.user.favorites.indexOf(a);s>-1&&usersData.user.favorites.splice(s,1)}displayFavoriteLinks(a)}})}function displayFavoriteLinks(e){var t=document.querySelector(".secretdiscounter-extension__shop .favorite-add"),a=document.querySelector(".secretdiscounter-extension__shop .favorite-remove");return usersData&&usersData.user?void(!usersData.user.favorites||usersData.user.favorites.indexOf(e)<0?(t&&t.classList.remove("sd_hidden"),a&&a.classList.add("sd_hidden")):(t&&t.classList.add("sd_hidden"),a&&a.classList.remove("sd_hidden"))):(t&&t.classList.add("sd_hidden"),a&&a.classList.add("sd_hidden"),null)}function findShop(){if(debug&&console.log("findShop"),usersData!==!1)storageDataStores&&storageDataStores.stores&&storeUtil.findShop(storageDataStores.stores,!1,displayShop);else var e=10,t=setInterval(function(){e--,debug&&console.log(usersData),usersData!==!1&&(storageDataStores&&storageDataStores.stores&&storeUtil.findShop(storageDataStores.stores,!1,displayShop),clearInterval(t)),e<0&&clearInterval(t)},1e3)}function testDisplayPage(e){return debug&&console.log("display on page "+(void 0===e||null===e||1==e||3==e)),void 0===e||null===e||1==e||3==e}function displayShop(e){if(testDisplayPage(e.display)&&(e&&(chrome.runtime.sendMessage({action:"icon_flash_start",cashback:utils.makeCashback(e.displayed_cashback,e.currency,e.action_id,!0),tab_url:window.location.href}),setTimeout(function(){chrome.runtime.sendMessage({action:"icon_flash_stop"})},5e3)),div=document.querySelector(".secretdiscounter-extension"),e&&!div&&(debug||!storeUtil.popupClosed(e.store_route)&&!storeUtil.isActivated(e.store_route)))){var t="",a="",r="",s="";usersData&&usersData.user?(t=frontUrl+utils.href("goto/store:"+e.uid),s=frontUrl+utils.href("stores"),a=frontUrl+utils.href(""),r='<a title="'+lg("add_to_favorite")+'" data-id="'+e.uid+'" data-type="add" class="favorite-add" href="'+utils.href("#vaforite_add")+'">'+iconFavoriteClose+'</a><a title="'+lg("remove_from_favorite")+'" data-id="'+e.uid+'" data-type="delete" class="sd_hidden favorite-remove" href="'+utils.href("#vaforite_remove")+'">'+iconFavoriteOpen+"</a>"):(t=frontUrl+utils.href("stores/"+e.store_route+"#login"),a=frontUrl+utils.href("#login"),s=frontUrl+utils.href("stores#login"));var o=lg("searchtext {{cashback}}",{cashback:utils.makeCashback(e.displayed_cashback,e.currency,e.action_id)}),n=storeUtil.isActivated(e.store_route),i=utils.replaceTemplate(storePluginHtml,{storeLogo:frontUrl+"images/logos/"+e.logo,storeUrl:t,storeText:o,siteUrl:a,favoritesLink:r,logoImage:logoImage,storeRoute:e.store_route,buttonsClass:n?"sd_hidden":"",storesUrl:s,buttonText:lg("activate_cashback"),buttonMessage:lg("store_will_open_in_new_window")});div=document.createElement("div"),div.className="secretdiscounter-extension",div.innerHTML=i,div.style.right="20px",div.style.top="10px";var d=10,u=setInterval(function(){d--;var t=document.body;t&&(clearInterval(u),t.insertBefore(div,t.firstChild),document.querySelector(".secretdiscounter-extension__button_close").onclick=closeClick,usersData&&usersData.user&&(document.querySelector(".secretdiscounter-extension__shop-favorites .favorite-add").onclick=changeFavorite,document.querySelector(".secretdiscounter-extension__shop-favorites .favorite-remove").onclick=changeFavorite),displayFavoriteLinks(e.uid),utils.makeHrefs(document.querySelector(".secretdiscounter-extension__buttons"),utils.doClickPlugunClose)),d<0&&clearInterval(u)},1e3)}}function setAppId(){var e=document.createElement("div");e.id=appIds[currentBrowser].id,e.style="display:none;",document.body.appendChild(e),debug&&console.log(appIds[currentBrowser])}function getCookie(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return!!t&&decodeURIComponent(t[1])}function analizPage(){debug&&console.log("analize Page"),storeUtil.analizeActivated(),setAppId(),searchAnalize.analize(),searchAnalize.yandexHandlerSet()}var usersData=!1,userLanguage=!1,isOpera=navigator.userAgent.indexOf(" OPR/")>=0,repeatTimes=!1,appIds={chrome:{id:"sd_chrome_app",search_delay:0},firefox:{id:"sd_firefox_app",search_delay:0},opera:{id:"sd_opera_app",search_delay:100},yandex:{id:"sd_yandex_app",search_delay:100}},currentBrowser="chrome";navigator.userAgent.indexOf(" OPR/")>=0?currentBrowser="opera":navigator.userAgent.indexOf(" YaBrowser/")>=0?currentBrowser="yandex":window.chrome&&window.chrome.webstore?currentBrowser="chrome":"undefined"!=typeof InstallTrigger&&(currentBrowser="firefox"),debug&&console.log(currentBrowser),getUsers();var appVersion=chrome.runtime.getManifest().version;Storage.load(function(){storageDataDate=Storage.get(storageDataKeyDate),storageDataStores=Storage.get(storageDataKeyStores),storageDataVersion=Storage.get(storageDataKeyVersion),storageDataLanguage=Storage.get(storageDataKeyLanguage);var e=Storage.get(storageDataKeyLanguageCurrent);userLanguage&&e!==userLanguage&&(e=userLanguage,Storage.set(storageDataKeyLanguageCurrent,e)),e&&(language=e),debug&&(console.log("storage load",storageDataStores,storageDataDate,storageDataVersion,storageDataLanguage,e),console.log(appVersion)),storageDataDate&&storageDataStores&&storageDataVersion&&storageDataLanguage&&!(((new Date).getTime()-storageDataDate)/36e5>24)&&storageDataVersion===appVersion&&storageDataLanguage===language?findShop():(debug&&console.log("start load data from server"),getData(findShop))}),chrome.runtime.sendMessage({action:"icon_flash_clear"}),document.addEventListener("DOMContentLoaded",analizPage);