function getUser(e){chrome.runtime.sendMessage({action:"sd_xhttp",url:siteUrl+utils.href(userUrl)},function(t){var s=!1;usersData=t,t.user?s=!!(usersData&&usersData.user&&usersData.user.language)&&usersData.user.language:t.language&&(s=t.language),s&&(language=s,Storage.set(storageDataKeyLanguageCurrent,language)),debug&&console.log(s,language),e()})}function getCoupons(e,t){return e&&e.store_route?void chrome.runtime.sendMessage({action:"sd_xhttp",url:siteUrl+utils.href(couponUrl+"/"+e.store_route)},function(e){t(e)}):null}function resetStyles(){document.querySelector(".secretdiscounter-pupup").classList.add("logout"),document.querySelector(".secretdiscounter-pupup__logo-link").setAttribute("href",siteUrl+utils.href("#login")),document.querySelector(".secretdiscounter-pupup__logo-link").innerHTML=logoImage,document.querySelector(".secretdiscounter-pupup__info").style.display="none",document.querySelector(".secretdiscounter-pupup__login").style.display="block",document.querySelector(".secretdiscounter-pupup__tab-favorites").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-coupons").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-notifications").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-shop").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-notifications .secretdiscounter-pupup__tab-content").innerHTML="",document.querySelector(".secretdiscounter-pupup__tab-favorites").style.display="block",document.querySelector(".secretdiscounter-pupup__tab-favorites .secretdiscounter-pupup__tab-content").innerHTML=lg("refreshing_data")}function makeFavorites(){if(!usersData||!usersData.user.favorites_full||0==usersData.user.favorites_full.length)return lg("you_have_not_favorites");result="";for(var e=0;e<usersData.user.favorites_full.length;e++){var t=storeUtil.isActivated(usersData.user.favorites_full[e].route);result+=utils.replaceTemplate(favoriteHTML,{storeLogo:siteUrl+"images/logos/"+usersData.user.favorites_full[e].logo,storeText:utils.makeCashback(usersData.user.favorites_full[e].displayed_cashback,usersData.user.favorites_full[e].currency,usersData.user.favorites_full[e].action_id),storeUrl:siteUrl+utils.href("goto/store:"+usersData.user.favorites_full[e].uid),storeRoute:utils.href(usersData.user.favorites_full[e].route),buttonClass:t?"sd_hidden":"",cashback:lg("cashback"),buttonText:lg("activate_cashback_to_line")})}return result+='<div class="secretdiscounter-extension__notification-button"><a class="secretdiscounter-extension__link" href="'+siteUrl+'/stores">'+lg("all_stores")+"</a></div>",result}function makeNotifications(){if(!usersData||!usersData.notifications)return"";result="";for(var e=0;e<usersData.notifications.length;e++)result+=utils.replaceTemplate(notificationHTML,{notyDate:usersData.notifications[e].data,notyTitle:usersData.notifications[e].title,notyText:usersData.notifications[e].text});return usersData.btn&&(result+='<div class="secretdiscounter-extension__notification-button"><a class="secretdiscounter-extension__link" href="'+siteUrl+utils.href(userUrl)+'">'+usersData.btn+"</a></div>"),result}utils.makeHrefs(document);var usersData,displayUser=function(){if(usersData&&usersData.user){var e=usersData.user.language;e&&(language=e,Storage.set(storageDataKeyLanguageCurrent,language)),document.querySelector(".secretdiscounter-pupup").classList.remove("logout"),document.querySelector(".secretdiscounter-pupup__info-logo-circle").innerHTML='<img class="secretdiscounter-pupup__info-logo-img" src="'+utils.getAvatar(usersData.user.photo)+'"/>',document.querySelector(".secretdiscounter-pupup__info-balance").innerHTML='<span class="secretdiscounter-pupup__info-balance-current">'+usersData.user.balance.current+'</span><span class="secretdiscounter-pupup__info-balance-pending">'+(usersData.user.balance.pending?"&nbsp;/&nbsp;"+usersData.user.balance.pending:"")+"&nbsp;"+usersData.user.currency+"</span>",document.querySelector(".secretdiscounter-pupup__tab-notifications").style.display="block",document.querySelector(".secretdiscounter-pupup__login").style.display="none",document.querySelector(".secretdiscounter-pupup__logo-link").setAttribute("href",siteUrl+utils.href("")),document.querySelector(".secretdiscounter-pupup__info").style.display="flex";var t=document.querySelector(".secretdiscounter-pupup__tab-notifications .secretdiscounter-pupup__tab-content");t.innerHTML=makeNotifications(),utils.makeHrefs(t);var s=document.querySelector(".secretdiscounter-pupup__tab-favorites .secretdiscounter-pupup__tab-content");s.innerHTML=makeFavorites(),utils.makeHrefs(s)}else document.querySelector(".secretdiscounter-pupup__tabs").style.display="none",resetStyles();document.querySelector(".secretdiscounter-pupup").style.display="block",document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-checkboxtab").checked=!0},displayShop=function(e){debug&&console.log("вывод шопа",e);var t=document.querySelector(".secretdiscounter-pupup__tab-shop");if(t.style.display="block",document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-checkboxtab").checked=!0,e){var s=storeUtil.isActivated(e.store_route);debug&&console.log("шоп активирован ",s),document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-content").innerHTML=utils.replaceTemplate(storeHtml,{storeLogo:siteUrl+"images/logos/"+e.logo,storeText:utils.makeCashback(e.displayed_cashback,e.currency,e.action_id),storeUrl:siteUrl+utils.href("goto/store:"+e.uid),btnText:lg("activate_cashback"),storeTariffs:e.conditions?'<div class="secretdiscounter-extension__buttons-tariffs-header">'+lg("terms_and_conditions")+":</div>"+e.conditions:"",storeRoute:utils.href(e.store_route),buttonsClass:s?"sd_hidden":"",cashback:lg("cashback"),buttonMessage:lg("store_will_open_in_new_window")}),getCoupons(e,displayCoupons)}else document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-content").innerHTML=utils.replaceTemplate(storeHtmlEmpty,{emptyCashbackMessage:lg("this_store_has_no_cashback"),allStores:lg("all_stores_with_cashback")});utils.makeHrefs(t)},displayCoupons=function(e){if(debug&&console.log("вывод купонов",e),e.coupons&&e.coupons.length){for(var t="",s=0;s<e.coupons.length;s++)t+=utils.replaceTemplate(couponHtml,{couponName:e.coupons[s].name,couponDateEnd:e.coupons[s].date_end,couponPromocode:e.coupons[s].promocode?e.coupons[s].promocode+'<span title="'+lg("copy_to_clipboard")+'"  class="secretdiscounter-extension__coupon-promocode-text-copy sd_button copy-clipboard" data-clipboard="'+e.coupons[s].promocode+'">'+iconCopy+"</span>":lg("code_not_required"),couponUseLink:siteUrl+utils.href("goto/coupon:"+e.coupons[s].uid),couponUrl:siteUrl+utils.href("coupons/"+e.coupons[s].store_route+"/"+e.coupons[s].uid),storeRoute:utils.href(e.coupons[s].store_route),dateExpireMessage:lg("coupon_date_end"),promocodeText:lg("coupon"),usePromocode:lg("use_coupon_code")});var o=document.querySelector(".secretdiscounter-pupup__tab-coupons .secretdiscounter-pupup__tab-content");o.innerHTML=t,utils.makeHrefs(o),utils.setClickHandlers(o,"copy-clipboard",utils.copyToClipboard),document.querySelector(".secretdiscounter-pupup__tab-coupons").style.display="block"}},htmlLanguage=function(){for(var e,t,s=document.getElementsByClassName("language_item"),o=0;o<s.length;o++)e=lg(s[o].getAttribute("data-language")),s[o].innerHTML=e;for(s=document.getElementsByClassName("language_item-href"),o=0;o<s.length;o++)t=lg(s[o].getAttribute("data-href")),s[o].setAttribute("href",siteUrl+utils.href(t))},refreshData=function(){htmlLanguage(),storeUtil.findShop(storageDataStores.stores,tabUrl,displayShop)};resetStyles(),displayShop(!1),getUser(displayUser);var appVersion=chrome.runtime.getManifest().version;chrome.tabs.query({active:!0,currentWindow:!0},function(e){tabUrl=e[0].url,debug&&console.log("получили урл текущей вкладки"+tabUrl),Storage.load(function(){storageDataDate=Storage.get(storageDataKeyDate),storageDataStores=Storage.get(storageDataKeyStores),storageDataVersion=Storage.get(storageDataKeyVersion),storageDataLanguage=Storage.get(storageDataKeyLanguage);var e=Storage.get(storageDataKeyLanguageCurrent);e&&(language=e),debug&&console.log("storage load"),!storageDataDate||!storageDataStores||!storageDataVersion||storageDataDate+864e5<(new Date).getTime()||storageDataVersion!==appVersion||storageDataLanguage!==language?getData(refreshData()):refreshData()})});