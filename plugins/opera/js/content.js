var usersData=!1,userLanguage=!1,isOpera=0<=navigator.userAgent.indexOf(" OPR/"),repeatTimes=!1,appIds={chrome:{id:"sd_chrome_app",search_delay:0},firefox:{id:"sd_firefox_app",search_delay:0},opera:{id:"sd_opera_app",search_delay:100},yandex:{id:"sd_yandex_app",search_delay:100}},currentBrowser="chrome";function closeClick(){var e=this.getAttribute("data-store");storeUtil.setPopupClosed(e),document.querySelector(".secretdiscounter-extension").style.display="none"}function getUsers(){debug&&console.log("getusers"),chrome.runtime.sendMessage({action:"sd_xhttp",url:siteUrl+utils.href(userUrl)},function(e){debug&&console.log("getusers success",e);var t=!1;(usersData=e).user?t=!!(usersData&&usersData.user&&usersData.user.language)&&usersData.user.language:e.language&&(t=e.language),t&&(language=t,userLanguage=t,Storage._loaded&&Storage.set(storageDataKeyLanguageCurrent,language))})}function changeFavorite(e){e.preventDefault();var a=this,s=a.getAttribute("data-id"),r=a.getAttribute("data-type");a.onclick=null,chrome.runtime.sendMessage({action:"sd_xhttp",method:"POST",url:siteUrl+utils.href(userFavoriteUrl),data:{affiliate_id:s,type:r}},function(e){if(a.onclick=changeFavorite,!e.error){if("add"===r)usersData.user.favorites.push(s);else{var t=usersData.user.favorites.indexOf(s);-1<t&&usersData.user.favorites.splice(t,1)}displayFavoriteLinks(s)}})}function displayFavoriteLinks(e){var t=document.querySelector(".secretdiscounter-extension__shop .favorite-add"),a=document.querySelector(".secretdiscounter-extension__shop .favorite-remove");if(!usersData||!usersData.user)return t&&t.classList.add("sd_hidden"),a&&a.classList.add("sd_hidden"),null;!usersData.user.favorites||usersData.user.favorites.indexOf(e)<0?(t&&t.classList.remove("sd_hidden"),a&&a.classList.add("sd_hidden")):(t&&t.classList.add("sd_hidden"),a&&a.classList.remove("sd_hidden"))}function findShop(){if(debug&&console.log("findShop"),!1!==usersData)storeUtil.findShop(storageDataStores.stores,!1,displayShop);else var e=10,t=setInterval(function(){e--,debug&&console.log(usersData),!1!==usersData&&(storeUtil.findShop(storageDataStores.stores,!1,displayShop),clearInterval(t)),e<0&&clearInterval(t)},1e3)}function testDisplayPage(e){return debug&&console.log("display on page "+(e===undefined||null===e||1==e||3==e)),e===undefined||null===e||1==e||3==e}function displayShop(t){if(testDisplayPage(t.display)&&(t&&(chrome.runtime.sendMessage({action:"icon_flash_start",cashback:utils.makeCashback(t.displayed_cashback,t.currency,t.action_id,!0),tab_url:window.location.href}),setTimeout(function(){chrome.runtime.sendMessage({action:"icon_flash_stop"})},5e3)),div=document.querySelector(".secretdiscounter-extension"),t&&!div&&(debug||!storeUtil.popupClosed(t.store_route)&&!storeUtil.isActivated(t.store_route)))){var e="",a="",s="",r="";usersData&&usersData.user?(e=siteUrl+utils.href("goto/store:"+t.uid),r=siteUrl+utils.href("stores"),a=siteUrl+utils.href(""),s='<a title="'+lg("add_to_favorite")+'" data-id="'+t.uid+'" data-type="add" class="favorite-add" href="'+utils.href("#vaforite_add")+'">'+iconFavoriteClose+'</a><a title="'+lg("remove_from_favorite")+'" data-id="'+t.uid+'" data-type="delete" class="sd_hidden favorite-remove" href="'+utils.href("#vaforite_remove")+'">'+iconFavoriteOpen+"</a>"):(e=siteUrl+utils.href("stores/"+t.store_route+"#login"),a=siteUrl+utils.href("#login"),r=siteUrl+utils.href("stores#login"));var o=lg("searchtext {{cashback}}",{cashback:utils.makeCashback(t.displayed_cashback,t.currency,t.action_id)}),i=storeUtil.isActivated(t.store_route),n=utils.replaceTemplate(storePluginHtml,{storeLogo:siteUrl+"images/logos/"+t.logo,storeUrl:e,storeText:o,siteUrl:a,favoritesLink:s,logoImage:logoImage,storeRoute:t.store_route,buttonsClass:i?"sd_hidden":"",storesUrl:r,buttonText:lg("activate_cashback"),buttonMessage:lg("store_will_open_in_new_window")});div=document.createElement("div"),div.className="secretdiscounter-extension",div.innerHTML=n,div.style.right="20px",div.style.top="10px";var u=10,d=setInterval(function(){u--;var e=document.body;e&&(clearInterval(d),e.insertBefore(div,e.firstChild),document.querySelector(".secretdiscounter-extension__button_close").onclick=closeClick,usersData&&usersData.user&&(document.querySelector(".secretdiscounter-extension__shop-favorites .favorite-add").onclick=changeFavorite,document.querySelector(".secretdiscounter-extension__shop-favorites .favorite-remove").onclick=changeFavorite),displayFavoriteLinks(t.uid),utils.makeHrefs(document.querySelector(".secretdiscounter-extension__buttons"),utils.doClickPlugunClose)),u<0&&clearInterval(d)},1e3)}}function setAppId(){var e=document.createElement("div");e.id=appIds[currentBrowser].id,e.style="display:none;",document.body.appendChild(e),debug&&console.log(appIds[currentBrowser])}function getCookie(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return!!t&&decodeURIComponent(t[1])}0<=navigator.userAgent.indexOf(" OPR/")?currentBrowser="opera":0<=navigator.userAgent.indexOf(" YaBrowser/")?currentBrowser="yandex":window.chrome&&window.chrome.webstore?currentBrowser="chrome":"undefined"!=typeof InstallTrigger&&(currentBrowser="firefox"),getUsers();var appVersion=chrome.runtime.getManifest().version;function analizPage(){storeUtil.analizeActivated(),setAppId(),searchAnalize.analize(),searchAnalize.yandexHandlerSet()}Storage.load(function(){storageDataDate=Storage.get(storageDataKeyDate),storageDataStores=Storage.get(storageDataKeyStores),storageDataVersion=Storage.get(storageDataKeyVersion),storageDataLanguage=Storage.get(storageDataKeyLanguage);var e=Storage.get(storageDataKeyLanguageCurrent);userLanguage&&e!==userLanguage&&(e=userLanguage,Storage.set(storageDataKeyLanguageCurrent,e)),e&&(language=e),debug&&(console.log("storage load",storageDataStores,storageDataDate,storageDataVersion,storageDataLanguage,e),console.log(appVersion)),storageDataDate&&storageDataStores&&storageDataVersion&&storageDataLanguage&&!(storageDataDate+864e5<(new Date).getTime())&&storageDataVersion===appVersion&&storageDataLanguage===language?findShop():getData(findShop)}),chrome.runtime.sendMessage({action:"icon_flash_clear"}),window.onload=analizPage;