function getUser(e){chrome.runtime.sendMessage({action:"sd_xhttp",url:siteUrl+userUrl},function(t){usersData=t,e()})}function getCoupons(e,t){return e&&e.store_route?void chrome.runtime.sendMessage({action:"sd_xhttp",url:siteUrl+couponUrl+"/"+e.store_route},function(e){t(e)}):null}function resetStyles(){document.querySelector(".secretdiscounter-pupup").classList.add("logout"),document.querySelector(".secretdiscounter-pupup__logo-link").setAttribute("href",siteUrl+"#login"),document.querySelector(".secretdiscounter-pupup__logo-link").innerHTML=logoImage,document.querySelector(".secretdiscounter-pupup__info").style.display="none",document.querySelector(".secretdiscounter-pupup__login").style.display="block",document.querySelector(".secretdiscounter-pupup__tab-favorites").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-coupons").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-notifications").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-shop").style.display="none",document.querySelector(".secretdiscounter-pupup__tab-notifications .secretdiscounter-pupup__tab-content").innerHTML="",document.querySelector(".secretdiscounter-pupup__tab-favorites").style.display="block",document.querySelector(".secretdiscounter-pupup__tab-favorites .secretdiscounter-pupup__tab-content").innerHTML="Обновление данных."}function makeFavorites(){if(!usersData||!usersData.user.favorites_full||0==usersData.user.favorites_full.length)return"На данный момент у Вас нет избранных магазинов.";result="";for(var e=0;e<usersData.user.favorites_full.length;e++){var t=storeUtil.isActivated(usersData.user.favorites_full[e].route);result+=utils.replaceTemplate(favoriteHTML,{storeLogo:siteUrl+"images/logos/"+usersData.user.favorites_full[e].logo,storeText:utils.makeCashback(usersData.user.favorites_full[e].displayed_cashback,usersData.user.favorites_full[e].currency,usersData.user.favorites_full[e].action_id),storeUrl:siteUrl+"goto/store:"+usersData.user.favorites_full[e].uid,storeRoute:usersData.user.favorites_full[e].route,buttonClass:t?"sd_hidden":""})}return result+='<div class="secretdiscounter-extension__notification-button"><a class="secretdiscounter-extension__link" href="'+siteUrl+'/stores">Все магазины</a></div>',result}function makeNotifications(){if(!usersData||!usersData.notifications)return"";result="";for(var e=0;e<usersData.notifications.length;e++)result+=utils.replaceTemplate(notificationHTML,{notyDate:usersData.notifications[e].data,notyTitle:usersData.notifications[e].title,notyText:usersData.notifications[e].text});return usersData.btn&&(result+='<div class="secretdiscounter-extension__notification-button"><a class="secretdiscounter-extension__link" href="'+siteUrl+userUrl+'">'+usersData.btn+"</a></div>"),result}utils.makeHrefs(document);var usersData,displayUser=function(){if(usersData&&usersData.user){document.querySelector(".secretdiscounter-pupup").classList.remove("logout"),document.querySelector(".secretdiscounter-pupup__info-logo-circle").innerHTML='<img class="secretdiscounter-pupup__info-logo-img" src="'+utils.getAvatar(usersData.user.photo)+'"/>',document.querySelector(".secretdiscounter-pupup__info-balance").innerHTML='<span class="secretdiscounter-pupup__info-balance-current">'+usersData.user.balance.current+'</span><span class="secretdiscounter-pupup__info-balance-pending">'+(usersData.user.balance.pending?"&nbsp;/&nbsp;"+usersData.user.balance.pending:"")+"&nbsp;руб.</span>",document.querySelector(".secretdiscounter-pupup__tab-notifications").style.display="block",document.querySelector(".secretdiscounter-pupup__login").style.display="none",document.querySelector(".secretdiscounter-pupup__logo-link").setAttribute("href",siteUrl),document.querySelector(".secretdiscounter-pupup__info").style.display="flex";var e=document.querySelector(".secretdiscounter-pupup__tab-notifications .secretdiscounter-pupup__tab-content");e.innerHTML=makeNotifications(),utils.makeHrefs(e);var t=document.querySelector(".secretdiscounter-pupup__tab-favorites .secretdiscounter-pupup__tab-content");t.innerHTML=makeFavorites(),utils.makeHrefs(t)}else document.querySelector(".secretdiscounter-pupup__tabs").style.display="none",resetStyles();document.querySelector(".secretdiscounter-pupup").style.display="block",document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-checkboxtab").checked=!0},displayShop=function(e){debug&&console.log("вывод шопа",e);var t=document.querySelector(".secretdiscounter-pupup__tab-shop");if(t.style.display="block",document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-checkboxtab").checked=!0,e){var s=storeUtil.isActivated(e.store_route);debug&&console.log("шоп активирован ",s),document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-content").innerHTML=utils.replaceTemplate(storeHtml,{storeLogo:siteUrl+"images/logos/"+e.logo,storeText:utils.makeCashback(e.displayed_cashback,e.currency,e.action_id),storeUrl:siteUrl+"goto/store:"+e.uid,btnText:(usersData&&usersData.user,"Активировать&nbsp;кэшбэк"),storeTariffs:e.conditions?'<div class="secretdiscounter-extension__buttons-tariffs-header">Все тарифы и условия:</div>'+e.conditions:"",storeRoute:e.store_route,buttonsClass:s?"sd_hidden":""}),getCoupons(e,displayCoupons)}else document.querySelector(".secretdiscounter-pupup__tab-shop .secretdiscounter-pupup__tab-content").innerHTML=storeHtmlEmpty;utils.makeHrefs(t)},displayCoupons=function(e){if(debug&&console.log("вывод купонов",e),e.coupons&&e.coupons.length){for(var t="",s=0;s<e.coupons.length;s++)t+=utils.replaceTemplate(couponHtml,{couponName:e.coupons[s].name,couponDateEnd:e.coupons[s].date_end,couponPromocode:e.coupons[s].promocode?e.coupons[s].promocode+'<span title="Скопировать в буфер обмена"  class="secretdiscounter-extension__coupon-promocode-text-copy sd_button copy-clipboard" data-clipboard="'+e.coupons[s].promocode+'">'+iconCopy+"</span>":"Не требуется",couponUseLink:siteUrl+"goto/coupon:"+e.coupons[s].uid,couponUrl:siteUrl+"coupons/"+e.coupons[s].store_route+"/"+e.coupons[s].uid,storeRoute:e.coupons[s].store_route});var o=document.querySelector(".secretdiscounter-pupup__tab-coupons .secretdiscounter-pupup__tab-content");o.innerHTML=t,utils.makeHrefs(o),utils.setClickHandlers(o,"copy-clipboard",utils.copyToClipboard),document.querySelector(".secretdiscounter-pupup__tab-coupons").style.display="block"}};resetStyles(),displayShop(!1),getUser(displayUser),chrome.tabs.query({active:!0,currentWindow:!0},function(e){tabUrl=e[0].url,debug&&console.log("получили урл текущей вкладки"+tabUrl);var t=chrome.runtime.getManifest().version;Storage.load(function(){storageDataDate=Storage.get(storageDataKeyDate),storageDataStores=Storage.get(storageDataKeyStores),storageDataVersion=Storage.get(storageDataKeyVersion),debug&&console.log("storage load"),!storageDataDate||!storageDataStores||!storageDataVersion||storageDataDate+864e5<(new Date).getTime()||storageDataVersion!==t?getData(storeUtil.findShop(storageDataStores.stores,tabUrl,displayShop)):storeUtil.findShop(storageDataStores.stores,tabUrl,displayShop)})});