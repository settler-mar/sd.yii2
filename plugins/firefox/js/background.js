var iconFlashInterval,iconFlashIntervalMax,defaultIcon=!0,iconFlashTime=300,stop=!0,maxFlashInterval=1e4,storeCashback=!1,currentTab=!1,tabsCashback=[];function displayCashback(a){a=a?a.toString():"",chrome.browserAction.setBadgeBackgroundColor({color:"#666"}),a=a.replace(/^\s+/,""),chrome.browserAction.setBadgeText({text:a})}function toggleIcon(){var a=defaultIcon?"img/favicon-32x32-little.png":"img/favicon-32x32.png";defaultIcon=!defaultIcon,chrome.browserAction.setIcon({path:a}),displayCashback(storeCashback),stop&&defaultIcon&&clearInterval(iconFlashInterval)}function iconFlashStart(e,o){chrome.tabs.getAllInWindow(null,function(a){for(var n=0;n<a.length;n++)if(a[n].url===o){var t=a[n].id;tabsCashback[t]=e}}),storeCashback=e,stop&&(defaultIcon=!0,clearInterval(iconFlashInterval),toggleIcon(),iconFlashInterval=setInterval(toggleIcon,iconFlashTime)),stop=!1,clearTimeout(iconFlashIntervalMax),iconFlashIntervalMax=setTimeout(iconFlashStop,maxFlashInterval)}function iconFlashForceStop(){defaultIcon=stop=!0,chrome.browserAction.setIcon({path:"img/favicon-32x32.png"}),displayCashback(!1),clearInterval(iconFlashInterval),clearTimeout(iconFlashIntervalMax)}function iconFlashStop(){stop=!0}function encodeQueryData(a){var n=[];for(var t in a)n.push(encodeURIComponent(t)+"="+encodeURIComponent(a[t]));return n.join("&")}function iconFlashClear(){iconFlashForceStop(),displayCashback(tabsCashback[currentTab]=!1)}chrome.tabs.onActivated.addListener(function(a){iconFlashForceStop(),currentTab=a,currentCashback=tabsCashback[currentTab]!==undefined&&null!==tabsCashback[currentTab]&&tabsCashback[currentTab],displayCashback(currentCashback)}),chrome.runtime.onMessage.addListener(function(a,n,t){if("sd_xhttp"==a.action){var e=new XMLHttpRequest,o=a.method||"GET";return"GET"===o?a.url+="?g=plugin":"POST"===o.toUpperCase()&&(a.data.g="plugin"),e.open(o,a.url,!0),e.responseType="json",e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){4==e.readyState&&t(e.response)},e.send(encodeQueryData(a.data)),!0}"icon_flash_start"===a.action&&iconFlashStart(a.cashback,a.tab_url),"icon_flash_stop"===a.action&&iconFlashStop(),"icon_flash_clear"===a.action&&iconFlashClear()});