{{ use('/yii/grid/GridView') }}
{% set title = 'Платежи' %}
{{ set(this, 'title', title) }}
{% if not this.params.breadcrumbs %}
{{ set(this, 'params', this.params|merge({'breadcrumbs': []})) }}
{% endif %}
{% set breadcrumbs = this.params.breadcrumbs %}
{% set breadcrumbs = breadcrumbs|merge([{'url':'/home','label':'Личный кабинет'}]) %}
{% set breadcrumbs = breadcrumbs|merge([title]) %}
{{ set(this, 'params', this.params|merge({'breadcrumbs': breadcrumbs})) }}
<div class="payments-index">
    <h1>{{ html.encode(this.title) }}</h1>
    <div class="col-md-12 payments-result">
        Количество покупок (подтвержденных/ожидающих): <span>{{ result_success.count }}/{{ result_waiting.count }}</span>
    </div>
    <div class="col-md-12 payments-result">
        Кэшбэк (подтвержденный/ожидаемый):  <span>{{ _nf(result_success.cashback, 2)|raw }}/{{ _nf(result_waiting.cashback, 2)|raw }} </span>
    </div>
    <form method="get" class="form-horizontal col-md-12 payments-search" style="margin: 20px auto;">
        <div class="form-group">
            <label class="col-sm-2 control-label" for="payments_select_store">Магазин</label>
            <div class="col-sm-10">
                <select class="form-control" name="storeId" id="payments_select_store">
                    <option value=""></option>
                    {% for index, store in stores %}
                        <option
                            value="{{ index }}"
                            data-points='[
                            {% for point in store.points %}
                                {"id":"{{ point.point_id }}","country":"{{ point.country}}","name":"{{ point.point_name}}","address":"{{ point.address}}"}
                                {% if loop.index < loop.length %},{% endif %}
                            {% endfor %}]'
                        {% if index == storeId %}selected{% endif %}
                        >{{ store.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label" for="payments_select_store_point">Торговая точка</label>
            <div class="col-sm-10">
                <select class="form-control" data-get="{{ store_point }}" name="store_point" id="payments_select_store_point">
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label" for="date_range">Период</label>
            <div  class="col-sm-8">
                {{ data_ranger | raw }}
            </div>
            <div class="col-sm-2">
                <input type="submit" value="Поиск" class="btn btn-primary">
            </div>
        </div>
    </form>

    {{ grid_view_widget({
            'dataProvider': dataProvider,
            'options': {
                'class': 'payments-grid-view'
            },
            'pager' : {
                'firstPageLabel' : true,
                'lastPageLabel' : true,
                'maxButtonCount':10
            },
            'filterModel': searchModel,
            'columns': [
                {'class': '\\yii\\grid\\SerialColumn'},
                'uid',
                {
                    'format':'raw',
                    'attribute':'storeName',
                    'value': table_data.store_name
                },
                {
                    'format':'raw',
                    'attribute':'storePointName',
                    'value': table_data.store_point_name
                },
                {
                    'format':'raw',
                    'attribute':'userEmail',
                    'value': table_data.email,
                    'label': 'Пользователь'
                },
                {
                    'format':'raw',
                    'attribute':'click_date',
                    'value': table_data.click_date,
                    'label': 'Дата'
                },
                'order_price',
                'reward',
                'cashback',
                {
                    'format':'raw',
                    'attribute':'status',
                    'value': table_data.status,
                    'filter': {
                        0: 'В ожидании',
                        1: 'Отменён',
                        2: 'Подтверждён',
                    },
                    'options': {
                        'class': 'col-sm-2',
                    }
                },
            ],
        })
    }}
{#
{
    'format':'raw',
    'attribute':'action_date',
    'value': table_data.action_date
},
'order_price',
'reward',
'cashback',
'status',
'click_date',
'action_date',
'status_updated',
'closing_date',
'cpa_id',
'additional_id',
'ref_bonus_id',
'ref_bonus',
'ref_id',
'loyalty_status',
'order_id',
'shop_percent',
'kurs',
'admin_comment',
'old_reward',
'old_order_price'
#}
</div>